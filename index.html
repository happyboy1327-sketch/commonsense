<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëœë¤ ìƒì‹ í€´ì¦ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Tailwind default) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e1e2d; /* ì§™ì€ ë°°ê²½ */
            color: #e0e0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* ë¸”ëŸ¬ íš¨ê³¼ë¥¼ ìœ„í•œ ë°°ê²½ ì»¨í…Œì´ë„ˆ */
        #app-container {
            background: rgba(30, 30, 50, 0.7); /* ë¶ˆíˆ¬ëª…í•œ ë°°ê²½ */
            backdrop-filter: blur(10px); /* ë¸”ëŸ¬ íš¨ê³¼ */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 600px;
            padding: 30px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ë³´ë¼-ì—°ë‘ ê·¸ë¼ë°ì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .gradient-button {
            background-image: linear-gradient(135deg, #a78bfa 0%, #4ade80 100%); /* ë³´ë¼ìƒ‰ -> ì—°ë‘ìƒ‰ */
            transition: all 0.3s ease;
            color: #1e1e2d;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(167, 139, 250, 0.4);
        }
        .gradient-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 222, 128, 0.5);
        }

        /* í€´ì¦ˆ ì¹´ë“œ ë””ìì¸ */
        .quiz-card {
            background: rgba(45, 45, 70, 0.9);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* í€´ì¦ˆ ì˜µì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .quiz-option-button {
            background-color: #374151; /* bg-gray-700 */
            color: #e0e0f0; /* text-white */
            border: 1px solid transparent;
            text-align: left;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .quiz-option-button:hover:not([disabled]) {
            background-color: #8b5cf6; /* hover:bg-purple-600 */
            border-color: #a78bfa;
        }

        /* íƒ€ì´ë¨¸ ìˆ«ìì— ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ ì ìš©ì„ ìœ„í•œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        #quiz-timer {
            transition: color 0.5s ease-in-out, filter 0.5s ease-in-out;
        }

        /* ì‹ ê·œ ì• ë‹ˆë©”ì´ì…˜: ë‚´ë ¤ì˜¤ê¸° + ë°ê²Œ */
        @keyframes timer-tick {
            0% {
                opacity: 0.5;
                transform: translateY(-10px) scale(0.9); /* ìœ„ì—ì„œ ì‹œì‘ */
                filter: brightness(1.5); /* ë°ê²Œ */
            }
            50% {
                opacity: 1;
                transform: translateY(0) scale(1.1); /* ì¤‘ì•™ìœ¼ë¡œ ë‚´ë ¤ì˜¤ë©´ì„œ ì•½ê°„ ì»¤ì§€ê³  */
                filter: brightness(2.5); /* ê°€ì¥ ë°ê²Œ */
            }
            100% {
                transform: translateY(0) scale(1.0);
                filter: brightness(1.0); /* ì›ë˜ ë°ê¸°ë¡œ ë³µê·€ */
            }
        }
        
        .timer-animate {
            animation: timer-tick 0.5s ease-out forwards;
        }
    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore ë¡œê¹… í™œì„±í™” (ë””ë²„ê¹… ìš©)
        setLogLevel('Debug');

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        window.db = null;
        window.auth = null;
        window.userId = null;
        
        // ìº”ë²„ìŠ¤ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * @description Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                // Firebase ë¯¸ì‚¬ìš© ì‹œì—ë„ ì•±ì€ ì‘ë™í•´ì•¼ í•˜ë¯€ë¡œ ê²½ê³ ë§Œ í‘œì‹œ
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", window.userId);
                    } else {
                        // ì´ˆê¸° í† í°ì´ ìˆìœ¼ë©´ ì»¤ìŠ¤í…€ ì¸ì¦, ì—†ìœ¼ë©´ ìµëª… ì¸ì¦ ì‹œë„
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    }
                    // ì¸ì¦ ìƒíƒœê°€ í™•ì •ëœ í›„ ë©”ì¸ ë©”ë‰´ ë Œë”ë§ ì‹œì‘
                    window.checkAndInitializeQuiz();
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                window.showNotification('ì‹œìŠ¤í…œ ì˜¤ë¥˜: Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í€´ì¦ˆ ê¸°ëŠ¥ì€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ë™í•˜ë„ë¡ ì‹œë„
                window.checkAndInitializeQuiz(); 
            }
        }

        // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
        window.onload = initializeFirebase;
    </script>
</head>
<body>

<div id="app-container">
    <h1 class="text-3xl font-bold mb-8 text-white">ëœë¤ ìƒì‹ í€´ì¦ˆ</h1>

    <div id="content" class="w-full flex flex-col items-center">
        <!-- ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ (ë©”ì¸ ë©”ë‰´, í€´ì¦ˆ, ë³µìŠµ ë“±) -->
    </div>

    <!-- ë¡œë”© ë° ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="notification-area" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 backdrop-blur-sm hidden flex justify-center items-center z-50">
        <div id="notification-box" class="quiz-card p-6 text-center shadow-2xl">
            <p id="notification-message" class="text-xl font-semibold"></p>
            <div id="loading-spinner" class="mt-4 animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-purple-400 mx-auto hidden"></div>
            <button id="notification-ok-button" class="gradient-button mt-6 py-2 px-6 rounded-full text-sm hidden" onclick="window.hideNotification()">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
    // =========================================================================
    // 1. ì „ì—­ ì„¤ì • ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // =========================================================================

    const QUIZ_TOPICS = [
        'ë””ì§€í„¸ ë¦¬í„°ëŸ¬ì‹œ', 'í™˜ê²½', 'ê³¼í•™', 'ì •ì¹˜', 'ê²½ì œ', 'ì‚¬íšŒ', 
        'êµ­ì–´ ë§ì¶¤ë²•', 'êµ­ì–´ ì†ë‹´', 'ì§€ë¦¬', 'ì—­ì‚¬'
    ];
    const LOCAL_STORAGE_QUIZ_KEY = 'accumulated_quiz_data';
    const LOCAL_STORAGE_HISTORY_KEY = 'quiz_history';
    const LOCAL_STORAGE_DATE_KEY = 'last_generated_date';
    const contentDiv = document.getElementById('content');
    
    // íƒ€ì´ë¨¸ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let timerInterval = null;
    const TIME_LIMIT = 15;
    
    let accumulatedQuizzes = [];
    let quizHistory = [];
    let currentQuizSet = [];
    let currentQuestionIndex = 0;
    let quizMode = 'quiz'; // 'quiz' or 'review'

    /** @description UUIDë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ëœë¤ ID) */
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    /** @description ë°°ì—´ì„ ì„ìŠµë‹ˆë‹¤. (Fisher-Yates ì•Œê³ ë¦¬ì¦˜) */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    /**
     * @description ì•Œë¦¼ ë©”ì‹œì§€ ë˜ëŠ” ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
     * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
     * @param {'loading'|'info'|'error'} type - ë©”ì‹œì§€ ìœ í˜•
     * @param {boolean} [showButton=false] - í™•ì¸ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
     */
    window.showNotification = (message, type, showButton = false) => {
        const area = document.getElementById('notification-area');
        const msg = document.getElementById('notification-message');
        const spinner = document.getElementById('loading-spinner');
        const button = document.getElementById('notification-ok-button');

        msg.textContent = message;
        spinner.classList.add('hidden');
        button.classList.add('hidden');

        if (type === 'loading') {
            spinner.classList.remove('hidden');
        } else if (showButton || type === 'error' || type === 'info') {
            button.classList.remove('hidden');
        }
        
        // ë°°ê²½ìƒ‰ ë° ìŠ¤íƒ€ì¼ ì¡°ì • (ì„ íƒì )
        const box = document.getElementById('notification-box');
        if (type === 'error') {
            box.style.borderColor = '#ef4444'; // Red
        } else {
            box.style.borderColor = 'rgba(167, 139, 250, 0.3)';
        }

        area.classList.remove('hidden');
    };

    /** @description ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ì„ ìˆ¨ê¹ë‹ˆë‹¤. */
    window.hideNotification = () => {
        document.getElementById('notification-area').classList.add('hidden');
    };

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. */
    function loadQuizData() {
        try {
            const data = localStorage.getItem(LOCAL_STORAGE_QUIZ_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
            return [];
        }
    }

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í€´ì¦ˆ ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. */
    function saveQuizData(data) {
        try {
            localStorage.setItem(LOCAL_STORAGE_QUIZ_KEY, JSON.stringify(data));
        } catch (e) {
            console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í€´ì¦ˆ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:", e);
        }
    }

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. */
    function loadQuizHistory() {
        try {
            const data = localStorage.getItem(LOCAL_STORAGE_HISTORY_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:", e);
            return [];
        }
    }

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í€´ì¦ˆ íˆìŠ¤í† ë¦¬ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. */
    function saveQuizHistory(data) {
        try {
            localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(data));
        } catch (e) {
            console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í€´ì¦ˆ íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:", e);
        }
    }

    // =========================================================================
    // 2. AI API ì—°ë™ (ë¬¸ì œ ìƒì„± ë¡œì§)
    // =========================================================================

    /**
     * @description AI APIë¥¼ í˜¸ì¶œí•˜ì—¬ ìƒˆë¡œìš´ í€´ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (4ì§€ì„ ë‹¤í˜•)
     * @param {number} count - ìƒì„±í•  ë¬¸ì œ ìˆ˜ (8 ë˜ëŠ” 4)
     * @returns {Promise<Array<Object>>} ìƒì„±ëœ í€´ì¦ˆ ë°°ì—´
     */
    async function generateNewQuestions(count) {
        window.showNotification(`ìƒˆë¡œìš´ í€´ì¦ˆ ${count}ê°œ ìƒì„± ì¤‘...`, 'loading');
        
        // count ê°œìˆ˜ë§Œí¼ ìƒì„±í•˜ê¸° ìœ„í•´ 2ë¬¸ì œì”© ìƒì„± ê°€ì •
        const topicsNeeded = Math.ceil(count / 2); 
        const questionsPerTopic = count / topicsNeeded; // 8ê°œë©´ 4ì£¼ì œ 2ë¬¸ì œ, 4ê°œë©´ 2ì£¼ì œ 2ë¬¸ì œ

        const shuffledTopics = [...QUIZ_TOPICS].sort(() => 0.5 - Math.random());
        const selectedTopics = shuffledTopics.slice(0, topicsNeeded);

        // SYSTEM PROMPT: ë¬¸ì œ ìˆ˜ë¥¼ ë™ì ìœ¼ë¡œ ì„¤ì •
        const systemPrompt = `Act as a strict quiz master. Generate exactly ${count} unique, challenging general knowledge questions in Korean, divided equally among ${topicsNeeded} topics: [${selectedTopics.join(', ')}]. You must generate exactly ${questionsPerTopic} questions per topic. For each question, provide the correct answer, three plausible incorrect distractors, and a detailed explanation in Korean covering why the answer is correct and briefly explaining why the incorrect options are wrong.`;
        
        const userQuery = `ìƒˆë¡œìš´ 4ì§€ì„ ë‹¤í˜• í€´ì¦ˆ ${count}ê°œë¥¼ ${selectedTopics.join(', ')} ì£¼ì œë¡œ ìƒì„±í•´ ì£¼ì„¸ìš”. ê° ë¬¸ì œì—ëŠ” ê³ ìœ  ID, ì£¼ì œ, ì§ˆë¬¸, ì •ë‹µ, ê·¸ë¦¬ê³  ì •ë‹µì„ í¬í•¨í•œ 4ê°œì˜ ë³´ê¸°(options) ë°°ì—´, ê·¸ë¦¬ê³  ì •ë‹µê³¼ ì˜¤ë‹µì— ëŒ€í•œ ëª…í™•í•œ í•´ì„¤ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${""}`;
        
        // JSON SCHEMA: í•´ì„¤ í¬í•¨
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "id": { "type": "STRING", "description": "ê³ ìœ  ì‹ë³„ì (UUID)" },
                    "topic": { "type": "STRING", "description": "10ê°€ì§€ ì£¼ì œ ì¤‘ í•˜ë‚˜" },
                    "question": { "type": "STRING", "description": "ì§ˆë¬¸ ë‚´ìš©" },
                    "answer": { "type": "STRING", "description": "ì •í™•í•œ ì •ë‹µ (ë³´ê¸° ì¤‘ í•˜ë‚˜)" },
                    "options": { 
                        "type": "ARRAY", 
                        "items": { "type": "STRING" },
                        "description": "ì •ë‹µì„ í¬í•¨í•œ 4ê°œì˜ ë³´ê¸°"
                    },
                    "explanation": { "type": "STRING", "description": "ì •ë‹µê³¼ ì˜¤ë‹µì„ í¬í•¨í•˜ëŠ” ìƒì„¸ í•´ì„¤" }
                },
                "required": ["id", "topic", "question", "answer", "options", "explanation"],
                "propertyOrdering": ["id", "topic", "question", "answer", "options", "explanation"]
            }
        };

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: responseSchema
            }
        };

        const maxRetries = 3;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`API response error: ${response.statusText}`);

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) throw new Error("API did not return structured content.");

                let newQuizzes = JSON.parse(jsonText);
                
                // ìƒì„±ëœ í€´ì¦ˆ ìœ íš¨ì„± ê²€ì‚¬ ë° ID ì¶”ê°€
                newQuizzes = newQuizzes.filter(q => 
                    q.question && q.answer && Array.isArray(q.options) && q.options.length === 4
                    && q.explanation
                ).map(q => ({
                    ...q,
                    id: q.id || generateUUID(),
                    topic: q.topic || 'ì¼ë°˜ ìƒì‹',
                    question: q.question,
                    answer: q.answer,
                    options: q.options,
                    explanation: q.explanation
                }));
                
                // í€´ì¦ˆ ìˆ˜ê°€ ìš”ì²­í•œ countì™€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì˜¤ë¥˜ ì²˜ë¦¬ (ì¬ì‹œë„)
                if (newQuizzes.length !== count) {
                    throw new Error(`Generated quiz count is ${newQuizzes.length}, expected ${count}.`);
                }
                
                window.hideNotification();
                return newQuizzes;
            } catch (error) {
                console.error(`Attempt ${i + 1} failed:`, error);
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
            }
        }
        
        // ìµœì¢… ì‹¤íŒ¨
        window.showNotification('í€´ì¦ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ í€´ì¦ˆë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.', 'error', true);
        return [];
    }

    /** @description ë¡œì»¬ ë°ì´í„°ì™€ í˜„ì¬ ë‚ ì§œë¥¼ í™•ì¸í•˜ì—¬ ìƒˆë¡œìš´ í€´ì¦ˆë¥¼ ìƒì„±í• ì§€ ê²°ì •í•©ë‹ˆë‹¤. */
    window.checkAndInitializeQuiz = async () => {
        accumulatedQuizzes = loadQuizData();
        quizHistory = loadQuizHistory();
        
        const lastDate = localStorage.getItem(LOCAL_STORAGE_DATE_KEY);
        const today = new Date().toDateString();
        
        if (accumulatedQuizzes.length === 0 || lastDate !== today) {
            // ì²« ì‹¤í–‰ì´ê±°ë‚˜ ì˜¤ëŠ˜ ë‚ ì§œì— ìƒì„±ëœ í€´ì¦ˆê°€ ì—†ëŠ” ê²½ìš° (8ê°œ ìƒì„± ì˜ˆì •)
            if (accumulatedQuizzes.length === 0) {
                 window.showNotification('ë¡œë”© ì™„ë£Œ. "í€´ì¦ˆ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜¤ëŠ˜ì˜ í€´ì¦ˆ 8ê°œë¥¼ ìƒì„±í•˜ê³  ë„ì „í•˜ì„¸ìš”.', 'info', true);
            } else {
                 window.showNotification('ìƒˆë¡œìš´ í•˜ë£¨ì…ë‹ˆë‹¤. "í€´ì¦ˆ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜¤ëŠ˜ì˜ í€´ì¦ˆ 8ê°œë¥¼ ìƒì„±í•˜ê³  ë„ì „í•˜ì„¸ìš”.', 'info', true);
            }
        } else {
            // ì˜¤ëŠ˜ ì´ë¯¸ ìƒì„±ëœ í€´ì¦ˆê°€ ìˆìŒ (4ê°œ ì¶”ê°€ ìƒì„± ì˜ˆì •)
            window.showNotification('ë¡œë”© ì™„ë£Œ. "í€´ì¦ˆ ì‹œì‘" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìƒˆë¡œìš´ í€´ì¦ˆ 4ê°œê°€ ì¶”ê°€ë˜ì–´ 8ë¬¸ì œ ì„¸íŠ¸ë¡œ ë„ì „í•©ë‹ˆë‹¤. í˜„ì¬ ì´ ' + accumulatedQuizzes.length + 'ê°œì˜ í€´ì¦ˆê°€ ëˆ„ì ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'info', true);
        }

        renderMainMenu();
    };

    // =========================================================================
    // 3. íƒ€ì´ë¨¸ ë¡œì§ (ì‹ ê·œ)
    // =========================================================================

    /** @description 15ì´ˆ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. */
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);

        let timeLeft = TIME_LIMIT;
        const timerElement = document.getElementById('quiz-timer');
        if (timerElement) {
            timerElement.textContent = timeLeft;
            timerElement.style.color = '#4ade80'; // Green

            timerInterval = setInterval(() => {
                timeLeft--;
                if (timerElement) {
                    timerElement.textContent = timeLeft;
                    
                    // ìƒ‰ìƒ ë³€ê²½ ë° ì• ë‹ˆë©”ì´ì…˜ (Green -> Yellow -> Red)
                    if (timeLeft <= 5) {
                        timerElement.style.color = '#ef4444'; // Red-400
                        timerElement.classList.add('animate-pulse');
                    } else if (timeLeft <= 10) {
                        timerElement.style.color = '#facc15'; // Yellow-400
                    }
                    
                    // ì‹ ê·œ ì• ë‹ˆë©”ì´ì…˜ ì ìš©: ë‚´ë ¤ì˜¤ê¸° + ë°ê²Œ
                    timerElement.classList.remove('timer-animate'); // ì´ì „ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
                    // requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ DOM ê°•ì œ ë¦¬í”Œë¡œìš° í›„ í´ë˜ìŠ¤ë¥¼ ë‹¤ì‹œ ì¶”ê°€í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘
                    // ë‘ ë²ˆì˜ rAF í˜¸ì¶œì€ í´ë˜ìŠ¤ ì œê±°/ì¶”ê°€ ì‚¬ì´ì˜ ì‹œê°ì  ê°„ê²©ì„ ë³´ì¥í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ì´ ë§¤ í‹±ë§ˆë‹¤ ì¬ì‹œì‘ë˜ë„ë¡ í•©ë‹ˆë‹¤.
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            timerElement.classList.add('timer-animate');
                        });
                    });

                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timeUp();
                }
            }, 1000);
        }
    }
    
    /** @description ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆì„ ë•Œ ì²˜ë¦¬í•©ë‹ˆë‹¤. */
    function timeUp() {
        // ì´ë¯¸ ë‹µë³€ì´ ì²˜ë¦¬ë˜ì—ˆìœ¼ë©´ ë¬´ì‹œ
        if (contentDiv.querySelector('#answer-reveal:not(.hidden)')) return; 
        
        // íƒ€ì´ë¨¸ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        const timerElement = document.getElementById('quiz-timer');
        if(timerElement) timerElement.classList.remove('animate-pulse', 'timer-animate');

        window.showNotification('â³ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!', 'info', true);
        
        // ì˜¤ë‹µ ì²˜ë¦¬ ë¡œì§ì„ ì§ì ‘ ì‹¤í–‰í•©ë‹ˆë‹¤.
        simulateTimeOverAnswer();
    }
    
    /** @description ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆì„ ë•Œ ì˜¤ë‹µ ì²˜ë¦¬ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤. */
    function simulateTimeOverAnswer() {
        const q = currentQuizSet[currentQuestionIndex];
        const resultMessage = document.getElementById('result-message');
        const answerReveal = document.getElementById('answer-reveal');
        const answerDisplay = document.getElementById('correct-answer-display');
        const explanationDisplay = document.getElementById('explanation-display'); 

        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìŠ¤íƒ€ì¼ ë³€ê²½
        contentDiv.querySelectorAll('.quiz-option-button').forEach(btn => {
            btn.disabled = true;
            btn.classList.remove('hover:bg-purple-600');
            
            // ì •ë‹µ í•˜ì´ë¼ì´íŠ¸
            const btnOption = btn.getAttribute('data-option');
            const normalizedCorrectAnswer = q.answer.toLowerCase().replace(/\s/g, '');
            const normalizedBtnOption = btnOption.toLowerCase().replace(/\s/g, '');
            
            if (normalizedBtnOption === normalizedCorrectAnswer) {
                 btn.classList.add('bg-green-800', 'border-green-500'); 
            }
        });

        answerDisplay.textContent = q.answer;
        explanationDisplay.textContent = q.explanation;
        answerReveal.classList.remove('hidden');

        resultMessage.innerHTML = '<span class="text-red-400">âŒ ì‹œê°„ ì´ˆê³¼! (ì˜¤ë‹µ ì²˜ë¦¬)</span>';
        
        // ì•Œë¦¼ ìˆ¨ê¸°ê¸°
        window.hideNotification();

        // íˆìŠ¤í† ë¦¬ ê¸°ë¡ (ì˜¤ë‹µìœ¼ë¡œ ê¸°ë¡)
        quizHistory.push({
            quizId: q.id,
            topic: q.topic,
            isCorrect: false, // ì‹œê°„ ì´ˆê³¼ëŠ” ë¬´ì¡°ê±´ ì˜¤ë‹µ
            answeredAt: new Date().toISOString()
        });
        saveQuizHistory(quizHistory);
    }
    
    // =========================================================================
    // 4. UI ë Œë”ë§ ë° ëª¨ë“œë³„ ë¡œì§
    // =========================================================================

    /** @description ë©”ì¸ ë©”ë‰´ í™”ë©´ì„ ë Œë”ë§í•©ë‹ˆë‹¤. */
    function renderMainMenu() {
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) clearInterval(timerInterval);

        quizMode = 'menu';
        const incorrectCount = quizHistory.filter(h => !h.isCorrect).length;

        contentDiv.innerHTML = `
            <div class="w-full text-center p-6">
                <p class="text-xl mb-12 text-gray-300">
                    í˜„ì¬ ëˆ„ì ëœ ì´ í€´ì¦ˆ ìˆ˜: <span class="text-purple-400 font-bold">${accumulatedQuizzes.length}</span>ê°œ
                </p>
                <div class="flex flex-col space-y-6">
                    <button id="start-quiz-btn" class="gradient-button w-full py-4 px-8 rounded-xl text-lg shadow-lg" onclick="startQuiz()">
                        ğŸš€ í€´ì¦ˆ ì„¸íŠ¸ ë„ì „ (8ë¬¸ì œ ëœë¤ í’€ì´)
                    </button>
                    <button id="review-mode-btn" class="gradient-button w-full py-4 px-8 rounded-xl text-lg shadow-lg" onclick="startReviewMode()">
                        ğŸ“š ë³µìŠµ ëª¨ë“œ (${incorrectCount}ê°œ í‹€ë¦° ë¬¸ì œ)
                    </button>
                    <p class="text-sm mt-8 text-gray-400">
                        * 'í€´ì¦ˆ ì„¸íŠ¸ ë„ì „' ì‹œ ì˜¤ëŠ˜ì˜ ì²« ì ‘ì†ì´ë©´ 8ê°œ, ì´í›„ëŠ” 4ê°œì˜ ìƒˆë¡œìš´ ë¬¸ì œê°€ ì¶”ê°€ë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        `;
    }

    // --- í€´ì¦ˆ ëª¨ë“œ ë¡œì§ ---

    /** @description í€´ì¦ˆ ëª¨ë“œë¥¼ ì‹œì‘í•˜ê³ , í•„ìš” ì‹œ ë¬¸ì œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. */
    async function startQuiz() {
        quizMode = 'quiz';
        currentQuestionIndex = 0;

        const lastDate = localStorage.getItem(LOCAL_STORAGE_DATE_KEY);
        const today = new Date().toDateString();

        let generateCount = 0;
        let isFirstAccessToday = lastDate !== today;

        if (isFirstAccessToday) {
            // 1. ì‹ ê·œ ë‚ ì§œ ìµœì´ˆ ì ‘ì†: 8ê°œ ìƒì„±
            generateCount = 8;
        } else if (accumulatedQuizzes.length === 0) {
            // í€´ì¦ˆ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ 8ê°œ ìƒì„± (ì•ˆì „ ì¥ì¹˜)
            generateCount = 8;
        } else {
            // 2. ê°™ì€ ë‚  ë‘ ë²ˆì§¸ ì ‘ì† ì´í›„: 4ê°œ ì¶”ê°€ ìƒì„±
            generateCount = 4;
        }

        if (generateCount > 0) {
            const newQuizzes = await generateNewQuestions(generateCount);
            
            if (newQuizzes.length === generateCount) {
                accumulatedQuizzes = [...accumulatedQuizzes, ...newQuizzes];
                saveQuizData(accumulatedQuizzes);
                
                if (isFirstAccessToday) {
                    // ì²« ì ‘ì† ì‹œì—ë§Œ ë‚ ì§œ ì—…ë°ì´íŠ¸
                    localStorage.setItem(LOCAL_STORAGE_DATE_KEY, today);
                    window.showNotification(`ğŸ‰ ì˜¤ëŠ˜ì˜ ìƒˆë¡œìš´ í€´ì¦ˆ ${generateCount}ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ ${accumulatedQuizzes.length}ê°œì˜ í€´ì¦ˆê°€ ëˆ„ì ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info', true);
                } else {
                    window.showNotification(`ğŸ‰ ì¶”ê°€ í€´ì¦ˆ ${generateCount}ê°œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ ${accumulatedQuizzes.length}ê°œì˜ í€´ì¦ˆê°€ ëˆ„ì ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info', true);
                }
            } else if (accumulatedQuizzes.length === 0) {
                // API í˜¸ì¶œ ì‹¤íŒ¨ AND ê¸°ì¡´ í€´ì¦ˆ ì—†ìŒ
                window.showNotification('í€´ì¦ˆ ë°ì´í„° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error', true);
                return;
            } else {
                // API í˜¸ì¶œ ì‹¤íŒ¨í–ˆì§€ë§Œ ê¸°ì¡´ í€´ì¦ˆ ìˆìŒ
                window.showNotification('ìƒˆ í€´ì¦ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ í€´ì¦ˆë¡œ í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'info', true);
            }
        } else if (accumulatedQuizzes.length === 0) {
             window.showNotification('í’€ ìˆ˜ ìˆëŠ” í€´ì¦ˆê°€ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.', 'error', true);
             renderMainMenu();
             return;
        }

        // === í•µì‹¬ ìˆ˜ì •: í€´ì¦ˆ ì„¸íŠ¸ í¬ê¸°ë¥¼ 8ë¡œ ê³ ì •í•˜ê³ , ì „ì²´ ë¬¸ì œì—ì„œ ëœë¤ ì¶”ì¶œ ===
        currentQuizSet = [...accumulatedQuizzes]
            .sort(() => 0.5 - Math.random()) // ì „ì²´ ë¬¸ì œë¥¼ ëœë¤í•˜ê²Œ ì„ìŒ
            .filter(q => q.options && q.options.length === 4) // ìœ íš¨ì„± ê²€ì‚¬
            .slice(0, 8); // ìµœëŒ€ 8ë¬¸ì œë¡œ ì„¸íŠ¸ í¬ê¸° ê³ ì •
        
        if (currentQuizSet.length === 0) {
            window.showNotification('í’€ ìˆ˜ ìˆëŠ” í€´ì¦ˆê°€ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.', 'error', true);
            renderMainMenu();
            return;
        }
        
        // ë°ì´í„°ê°€ 8ê°œ ë¯¸ë§Œì¸ ê²½ìš°ì—ë„ ì„¸ì…˜ ì‹œì‘ (ì˜ˆ: ì²˜ìŒ ì‹œì‘í•˜ì—¬ 8ê°œë§Œ ìƒì„±ë˜ì—ˆì„ ë•Œ)
        
        renderQuestion();
    }

    /** @description í˜„ì¬ ë¬¸ì œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */
    function renderQuestion() {
        // ì´ì „ íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) clearInterval(timerInterval);

        if (currentQuestionIndex >= currentQuizSet.length) {
            endQuiz();
            return;
        }

        const q = currentQuizSet[currentQuestionIndex];
        
        // ì˜µì…˜ì„ ë³µì‚¬í•˜ê³  ì„ìŠµë‹ˆë‹¤. (4ì§€ì„ ë‹¤í˜•)
        let shuffledOptions = [...(q.options || [q.answer])];
        if (shuffledOptions.length === 4) {
            shuffledOptions = shuffleArray(shuffledOptions);
        } else {
            shuffledOptions = [q.answer];
        }


        const optionsHtml = shuffledOptions.map((option, index) => `
            <button class="quiz-option-button w-full py-3 px-4 rounded-xl text-lg text-left mb-3 shadow-md" 
                    data-option="${option}" onclick="selectAnswer('${option}')">
                ${['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][index]} ${option}
            </button>
        `).join('');


        contentDiv.innerHTML = `
            <div class="flex justify-between items-center w-full mb-4">
                <!-- íƒ€ì´ë¨¸ í‘œì‹œ ì˜ì—­ (ì‹ ê·œ) -->
                <p class="text-base text-purple-300">
                    ${currentQuestionIndex + 1}/${currentQuizSet.length} | ì£¼ì œ: ${q.topic}
                </p>
                <div id="quiz-timer" class="text-4xl font-extrabold text-green-400 leading-none">
                    ${TIME_LIMIT}
                </div>
            </div>

            <div class="quiz-card mb-6 w-full shadow-2xl">
                <p class="text-2xl font-semibold text-white">
                    Q. ${q.question}
                </p>
            </div>
            
            <div id="options-container" class="w-full">
                ${optionsHtml}
            </div>

            <div id="result-message" class="mt-4 text-center font-bold text-xl min-h-[30px]"></div>
            
            <div id="answer-reveal" class="quiz-card mt-4 hidden text-center">
                <p class="text-sm text-gray-300">ì •ë‹µ</p>
                <p class="text-2xl font-extrabold text-green-400 mb-3" id="correct-answer-display"></p>
                
                <!-- í•´ì„¤ ì˜ì—­ -->
                <div class="text-left bg-gray-700 p-4 rounded-lg mt-4">
                    <p class="text-sm font-semibold text-purple-300 mb-2">í•´ì„¤</p>
                    <p class="text-base text-gray-200" id="explanation-display"></p>
                </div>
                
                <button class="gradient-button mt-4 py-2 px-6 rounded-full text-sm" onclick="nextQuestion()">
                    ë‹¤ìŒ ë¬¸ì œ
                </button>
            </div>
        `;
        
        // í€´ì¦ˆ ë Œë”ë§ í›„ íƒ€ì´ë¨¸ ì‹œì‘
        startTimer();
    }

    /** @description í€´ì¦ˆ ì •ë‹µì„ í™•ì¸í•˜ê³  ê²°ê³¼ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤. */
    window.selectAnswer = (selectedOption) => {
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) clearInterval(timerInterval);
        
        // ì´ë¯¸ ë‹µë³€ì„ ì²˜ë¦¬í–ˆëŠ”ì§€ í™•ì¸
        if (contentDiv.querySelector('#answer-reveal:not(.hidden)')) return; 

        // íƒ€ì´ë¨¸ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        const timerElement = document.getElementById('quiz-timer');
        if(timerElement) timerElement.classList.remove('animate-pulse', 'timer-animate');
        
        const q = currentQuizSet[currentQuestionIndex];
        const normalizedSelected = selectedOption.toLowerCase().replace(/\s/g, '');
        const normalizedCorrectAnswer = q.answer.toLowerCase().replace(/\s/g, '');

        const isCorrect = normalizedSelected === normalizedCorrectAnswer;
        
        const resultMessage = document.getElementById('result-message');
        const answerReveal = document.getElementById('answer-reveal');
        const answerDisplay = document.getElementById('correct-answer-display');
        const explanationDisplay = document.getElementById('explanation-display'); 

        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìŠ¤íƒ€ì¼ ë³€ê²½
        contentDiv.querySelectorAll('.quiz-option-button').forEach(btn => {
            btn.disabled = true;
            const btnOption = btn.getAttribute('data-option');
            const normalizedBtnOption = btnOption.toLowerCase().replace(/\s/g, '');
            
            if (normalizedBtnOption === normalizedSelected) {
                 // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì˜µì…˜
                 btn.classList.add(isCorrect ? 'bg-green-600' : 'bg-red-600');
                 btn.classList.remove('bg-gray-700', 'hover:bg-purple-600');
            } else if (normalizedBtnOption === normalizedCorrectAnswer) {
                 // ì •ë‹µ í•˜ì´ë¼ì´íŠ¸ (ì‚¬ìš©ì ì„ íƒê³¼ ë¬´ê´€í•˜ê²Œ)
                 btn.classList.add('bg-green-800', 'border-green-500'); 
                 btn.classList.remove('bg-gray-700', 'hover:bg-purple-600');
            } else {
                 btn.classList.remove('hover:bg-purple-600');
            }
        });


        answerDisplay.textContent = q.answer;
        explanationDisplay.textContent = q.explanation; // Set the explanation text
        answerReveal.classList.remove('hidden');

        if (isCorrect) {
            resultMessage.innerHTML = '<span class="text-green-400">âœ… ì •ë‹µì…ë‹ˆë‹¤!</span>';
        } else {
            resultMessage.innerHTML = '<span class="text-red-400">âŒ ì˜¤ë‹µì…ë‹ˆë‹¤.</span>';
        }

        // íˆìŠ¤í† ë¦¬ ê¸°ë¡
        quizHistory.push({
            quizId: q.id,
            topic: q.topic,
            isCorrect: isCorrect,
            answeredAt: new Date().toISOString()
        });
        saveQuizHistory(quizHistory);
    };

    /** @description ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤. */
    window.nextQuestion = () => {
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) clearInterval(timerInterval);
        currentQuestionIndex++;
        renderQuestion();
    };

    /** @description í€´ì¦ˆë¥¼ ì¢…ë£Œí•˜ê³  ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. */
    function endQuiz() {
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) clearInterval(timerInterval);

        const total = currentQuizSet.length;
        // ì´ë²ˆ ì„¸íŠ¸ì˜ íˆìŠ¤í† ë¦¬ë§Œ í•„í„°ë§
        const recentHistory = quizHistory.slice(-total); 
        const correctCount = recentHistory.filter(h => h.isCorrect).length;
        const score = Math.round((correctCount / total) * 100);

        contentDiv.innerHTML = `
            <div class="quiz-card w-full text-center p-8 shadow-2xl">
                <p class="text-4xl font-extrabold mb-4 text-purple-400">í€´ì¦ˆ ì¢…ë£Œ!</p>
                <p class="text-2xl mb-8">
                    ì´ ${total}ë¬¸ì œ ì¤‘ <span class="text-green-400 font-bold">${correctCount}ê°œ</span> ì •ë‹µ!
                </p>
                <p class="text-6xl font-black mb-8">${score}ì </p>
                
                <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" onclick="renderMainMenu()">
                    ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        `;
    }


    // --- ë³µìŠµ ëª¨ë“œ ë¡œì§ ---

    /** @description ë³µìŠµ ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. */
    function startReviewMode() {
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) clearInterval(timerInterval);

        quizMode = 'review';
        currentQuestionIndex = 0;
        
        // ì˜¤ë‹µ ê¸°ë¡ë§Œ í•„í„°ë§
        const incorrectHistory = quizHistory.filter(h => !h.isCorrect);

        // ì˜¤ë‹µ ê¸°ë¡ì—ì„œ ë¬¸ì œ IDë¥¼ ì¶”ì¶œí•˜ì—¬ ì‹¤ì œ í€´ì¦ˆ ë°ì´í„°ì™€ ì—°ê²°
        currentQuizSet = incorrectHistory.map(h => {
            const quiz = accumulatedQuizzes.find(q => q.id === h.quizId);
            return quiz ? { ...quiz, historyId: h.quizId } : null;
        }).filter(q => q && q.options && q.options.length === 4); // 4ì§€ì„ ë‹¤í˜• ë¬¸ì œë§Œ ë³µìŠµ

        const incorrectCount = currentQuizSet.length;

        if (incorrectCount === 0) {
            window.showNotification('ğŸ‰ í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ì™„ë²½í•´ìš”.', 'info', true);
            renderMainMenu();
            return;
        }

        window.showNotification(`ğŸ“š ë³µìŠµ ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì´ ${incorrectCount}ê°œì˜ í‹€ë¦° ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.`, 'info');
        renderReviewQuestion();
    }

    /** @description ë³µìŠµ ë¬¸ì œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. (ì •ë‹µì„ ì¦‰ì‹œ í‘œì‹œ) */
    function renderReviewQuestion() {
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) clearInterval(timerInterval);

        if (currentQuestionIndex >= currentQuizSet.length) {
            endReview();
            return;
        }

        const q = currentQuizSet[currentQuestionIndex];
        
        // ì˜µì…˜ì„ ë³µì‚¬í•˜ê³  ì„ìŠµë‹ˆë‹¤. (ë³µìŠµ ëª¨ë“œì—ì„œë„ ìˆœì„œëŠ” ì„ì–´ì„œ í‘œì‹œ)
        let shuffledOptions = [...(q.options || [q.answer])];
        if (shuffledOptions.length === 4) {
             shuffledOptions = shuffleArray(shuffledOptions);
        } else {
            shuffledOptions = [q.answer];
        }

        const optionsHtml = shuffledOptions.map((option, index) => {
            const isCorrectOption = option.toLowerCase().replace(/\s/g, '') === q.answer.toLowerCase().replace(/\s/g, '');
            // ë³µìŠµ ëª¨ë“œì—ì„œëŠ” ì •ë‹µì„ ë°”ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
            const style = isCorrectOption ? 'bg-green-800 text-white font-bold border-green-500' : 'bg-gray-700 text-gray-300 border-transparent';
            
            return `
                <button class="w-full py-3 px-4 rounded-xl text-lg text-left mb-3 shadow-md border ${style}" disabled>
                    ${['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][index]} ${option} ${isCorrectOption ? ' âœ… ì •ë‹µ' : ''}
                </button>
            `;
        }).join('');

        contentDiv.innerHTML = `
            <div class="quiz-card w-full mb-6 shadow-2xl">
                <p class="text-sm text-purple-300 mb-2">
                    ë³µìŠµ ë¬¸ì œ ${currentQuestionIndex + 1}/${currentQuizSet.length} | ì£¼ì œ: ${q.topic}
                </p>
                <p class="text-2xl font-semibold mb-6 text-white">
                    Q. ${q.question}
                </p>
            </div>
            
            <div id="options-container" class="w-full mb-4">
                ${optionsHtml}
            </div>
            
            <!-- ë³µìŠµ ëª¨ë“œ í•´ì„¤ ì˜ì—­ -->
            <div class="text-left quiz-card p-4 rounded-lg mt-4 w-full">
                <p class="text-sm font-semibold text-purple-300 mb-2">ì •ë‹µ: <span class="text-green-400 font-bold">${q.answer}</span></p>
                <p class="text-sm font-semibold text-purple-300 mb-2 mt-4 border-t border-gray-600 pt-4">í•´ì„¤</p>
                <p class="text-base text-gray-200">${q.explanation || 'í•´ì„¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
            </div>

            <button class="gradient-button mt-6 w-full py-3 rounded-xl text-lg shadow-lg" onclick="nextReviewQuestion()">
                ë‹¤ìŒ ë³µìŠµ ë¬¸ì œ í™•ì¸
            </button>
            
            <button class="text-sm text-gray-400 mt-4 hover:text-red-400 transition-colors" onclick="removeReviewItem('${q.id}')">
                âœ… ì´ ë¬¸ì œ ì´ì œ ì•Œì•„ìš” (ì˜¤ë‹µ ëª©ë¡ì—ì„œ ì œê±°)
            </button>
        `;
    }

    /** @description ë‹¤ìŒ ë³µìŠµ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤. */
    window.nextReviewQuestion = () => {
        currentQuestionIndex++;
        renderReviewQuestion();
    };
    
    /** @description ë³µìŠµ ëª©ë¡ì—ì„œ í•´ë‹¹ ë¬¸ì œë¥¼ ì œê±°í•˜ê³  íˆìŠ¤í† ë¦¬ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. */
    window.removeReviewItem = (quizId) => {
        quizHistory = quizHistory.filter(h => !(h.quizId === quizId && !h.isCorrect));
        saveQuizHistory(quizHistory);
        
        // ë³µìŠµ ì…‹ ì—…ë°ì´íŠ¸ í›„ ë‹¤ìŒ ë¬¸ì œë¡œ
        startReviewMode();
    };

    /** @description ë³µìŠµ ëª¨ë“œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. */
    function endReview() {
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) clearInterval(timerInterval);

        contentDiv.innerHTML = `
            <div class="quiz-card w-full text-center p-8 shadow-2xl">
                <p class="text-4xl font-extrabold mb-4 text-green-400">ë³µìŠµ ì™„ë£Œ!</p>
                <p class="text-xl mb-8">
                    í‹€ë ¸ë˜ ëª¨ë“  ë¬¸ì œë¥¼ í™•ì¸í•˜ì…¨ìŠµë‹ˆë‹¤.
                </p>
                
                <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" onclick="renderMainMenu()">
                    ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        `;
    }
    
    // =========================================================================
    // 5. ì´ˆê¸° ë¡œë“œ
    // =========================================================================
    
    // Firebase ì´ˆê¸°í™”ëŠ” <script type="module"> ë¸”ë¡ì—ì„œ ì²˜ë¦¬
    // window.onload ì‹œì ì— window.checkAndInitializeQuiz()ê°€ í˜¸ì¶œë˜ì–´ ë©”ì¸ ë©”ë‰´ë¥¼ ë Œë”ë§í•¨
</script>

</body>
</html>