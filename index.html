<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëœë¤ ìƒì‹ í€´ì¦ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Tailwind default) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e1e2d; /* ì§™ì€ ë°°ê²½ */
            color: #e0e0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* ë¸”ëŸ¬ íš¨ê³¼ë¥¼ ìœ„í•œ ë°°ê²½ ì»¨í…Œì´ë„ˆ */
        #app-container {
            background: rgba(30, 30, 50, 0.7); /* ë¶ˆíˆ¬ëª…í•œ ë°°ê²½ */
            backdrop-filter: blur(10px); /* ë¸”ëŸ¬ íš¨ê³¼ */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 95%;
            padding: 0;
            overflow: hidden; /* ë‚´ë¶€ ìš”ì†Œê°€ ë„˜ì¹˜ì§€ ì•Šë„ë¡ */
        }
        
        /* ë©”ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .gradient-button {
            background: linear-gradient(135deg, #4f46e5 0%, #a855f7 100%); /* ë³´ë¼ìƒ‰ ê³„ì—´ ê·¸ë¼ë°ì´ì…˜ */
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(168, 85, 247, 0.5);
        }

        .gradient-button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* í€´ì¦ˆ ì˜µì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .option-button {
            background-color: #3e3e5d; /* ì˜µì…˜ ë°°ê²½ */
            border: 2px solid #5a5a7a;
            transition: background-color 0.1s, border-color 0.1s;
        }

        .option-button:hover:not(:disabled) {
            background-color: #4a4a6e;
            border-color: #8b5cf6; /* hover ì‹œ ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ */
        }

        /* ì •ë‹µ/ì˜¤ë‹µ ìŠ¤íƒ€ì¼ */
        .correct {
            background-color: #10b981 !important; /* ì—ë©”ë„ë“œ ê·¸ë¦° */
            border-color: #059669 !important;
            color: white !important;
        }

        .incorrect {
            background-color: #ef4444 !important; /* ë¹¨ê°„ìƒ‰ */
            border-color: #dc2626 !important;
            color: white !important;
        }

        .faded-out {
            opacity: 0.5;
            pointer-events: none;
        }

        .quiz-card {
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <div id="app-container" class="p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-white">ëœë¤ ìƒì‹ í€´ì¦ˆ</h1>
        </header>
        <div id="content" class="w-full">
            <!-- Content will be rendered here by JavaScript -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”
        setLogLevel('Debug');

        // =========================================================================
        // 1. Firebase ë° ì „ì—­ ìƒíƒœ ì„¤ì •
        // =========================================================================

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'loading'; // ì´ˆê¸° ìƒíƒœ

        // ì „ì—­ UI ìš”ì†Œ
        const contentDiv = document.getElementById('content');

        // í€´ì¦ˆ ê´€ë ¨ ìƒíƒœ
        let quizzes = [];             // í˜„ì¬ ë‚œì´ë„ì˜ ëª¨ë“  í€´ì¦ˆ
        let currentQuizSet = [];      // ì‹¤ì œë¡œ í’€ í€´ì¦ˆ ëª©ë¡ (ëœë¤ ì¶”ì¶œëœ 10ê°œ)
        let currentQuizIndex = 0;     // í˜„ì¬ í’€ê³  ìˆëŠ” í€´ì¦ˆì˜ ì¸ë±ìŠ¤
        let quizHistory = [];         // ì‚¬ìš©ìê°€ í‘¼ ëª¨ë“  í€´ì¦ˆ ê¸°ë¡ (Firestore ë™ê¸°í™”)
        let timerInterval = null;     // í€´ì¦ˆ íƒ€ì´ë¨¸
        let timeRemaining = 15;       // ë¬¸ì œë‹¹ ì‹œê°„ (ì´ˆ)
        let selectedDifficulty = 'Easy'; // í˜„ì¬ ì„ íƒëœ ë‚œì´ë„

        // =========================================================================
        // 2. ë°ì´í„° êµ¬ì¡° ë° ëª¨ì˜ ë°ì´í„° (í•´ì„¤ í•„ë“œ ì¶”ê°€)
        // =========================================================================

        /** @typedef {Object} Quiz
         * @property {string} id
         * @property {string} question
         * @property {string[]} options
         * @property {number} answerIndex
         * @property {'Easy'|'Normal'|'Hard'} difficulty
         * @property {string} explanation // í•´ì„¤ í•„ë“œ ì¶”ê°€
         */

        /** @type {Quiz[]} */
        const mockQuizzes = [
            // Easy
            { id: 'e1', question: 'ì§€êµ¬ìƒì—ì„œ ê°€ì¥ í° í¬ìœ ë¥˜ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?', options: ['ì½”ë¼ë¦¬', 'ê¸°ë¦°', 'í°ìˆ˜ì—¼ê³ ë˜', 'í•˜ë§ˆ'], answerIndex: 2, difficulty: 'Easy', explanation: 'í°ìˆ˜ì—¼ê³ ë˜(Blue Whale)ëŠ” ì§€êµ¬ìƒì— ì¡´ì¬í•˜ëŠ” ê°€ì¥ í° ë™ë¬¼ì´ë©°, ê¸¸ì´ 30m, ë¬´ê²Œ 180í†¤ì„ ì´ˆê³¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
            { id: 'e2', question: 'ëŒ€í•œë¯¼êµ­ì˜ ìˆ˜ë„ëŠ” ì–´ë””ì¼ê¹Œìš”?', options: ['ë¶€ì‚°', 'ì„œìš¸', 'ì œì£¼', 'í‰ì–‘'], answerIndex: 1, difficulty: 'Easy', explanation: 'ëŒ€í•œë¯¼êµ­ì˜ ìˆ˜ë„ëŠ” ì„œìš¸íŠ¹ë³„ì‹œì…ë‹ˆë‹¤.' },
            { id: 'e3', question: 'ë¬¼ì˜ í™”í•™ ê¸°í˜¸ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?', options: ['O2', 'CO2', 'H2O', 'NaCl'], answerIndex: 2, difficulty: 'Easy', explanation: 'ë¬¼ì€ ë‘ ê°œì˜ ìˆ˜ì†Œ ì›ìì™€ í•œ ê°œì˜ ì‚°ì†Œ ì›ìë¡œ ì´ë£¨ì–´ì ¸ Hâ‚‚Oë¡œ í‘œê¸°í•©ë‹ˆë‹¤.' },
            { id: 'e4', question: 'íƒœì–‘ê³„ì˜ ì¤‘ì‹¬ì— ìˆëŠ” í•­ì„±ì€ ë¬´ì—‡ì¼ê¹Œìš”?', options: ['ì§€êµ¬', 'ë‹¬', 'í™”ì„±', 'íƒœì–‘'], answerIndex: 3, difficulty: 'Easy', explanation: 'íƒœì–‘ê³„ì˜ ì¤‘ì‹¬ì—ëŠ” íƒœì–‘ì´ ìˆìœ¼ë©°, íƒœì–‘ì€ ìŠ¤ìŠ¤ë¡œ ë¹›ì„ ë‚´ëŠ” í•­ì„±ì…ë‹ˆë‹¤.' },
            { id: 'e5', question: 'ì‚¬ê³„ì ˆ ì¤‘ ê°€ì¥ ì¶”ìš´ ê³„ì ˆì€ ë¬´ì—‡ì¼ê¹Œìš”?', options: ['ë´„', 'ì—¬ë¦„', 'ê°€ì„', 'ê²¨ìš¸'], answerIndex: 3, difficulty: 'Easy', explanation: 'ì‚¬ê³„ì ˆ ì¤‘ ê²¨ìš¸ì´ ê¸°ì˜¨ì´ ê°€ì¥ ë‚®ì•„ ê°€ì¥ ì¶”ìš´ ê³„ì ˆì…ë‹ˆë‹¤.' },
            // Normal
            { id: 'n1', question: 'ë¥´ë„¤ìƒìŠ¤ ì‹œëŒ€ì˜ ëŒ€í‘œì ì¸ í™”ê°€ë¡œ "ëª¨ë‚˜ë¦¬ì"ë¥¼ ê·¸ë¦° ì‚¬ëŒì€ ëˆ„êµ¬ì¼ê¹Œìš”?', options: ['ë¹ˆì„¼íŠ¸ ë°˜ ê³ í', 'ë ˆì˜¤ë‚˜ë¥´ë„ ë‹¤ë¹ˆì¹˜', 'íŒŒë¸”ë¡œ í”¼ì¹´ì†Œ', 'í´ë¡œë“œ ëª¨ë„¤'], answerIndex: 1, difficulty: 'Normal', explanation: 'ë ˆì˜¤ë‚˜ë¥´ë„ ë‹¤ë¹ˆì¹˜(Leonardo da Vinci)ëŠ” ëª¨ë‚˜ë¦¬ì ì™¸ì—ë„ ìµœí›„ì˜ ë§Œì°¬ ë“±ì˜ ê±¸ì‘ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤.' },
            { id: 'n2', question: 'ì¤‘êµ­ì˜ ë§Œë¦¬ì¥ì„±ì€ ë¬´ì—‡ì„ ë§‰ê¸° ìœ„í•´ ê±´ì„¤ë˜ì—ˆì„ê¹Œìš”?', options: ['ìì—°ì¬í•´', 'ì´ë¯¼ì ìœ ì…', 'ë¶ë°© ë¯¼ì¡±ì˜ ì¹¨ì…', 'ë¬´ì—­ì„  ì¶œì…'], answerIndex: 2, difficulty: 'Normal', explanation: 'ë§Œë¦¬ì¥ì„±ì€ ê³ ëŒ€ ì¤‘êµ­ì˜ ì—¬ëŸ¬ ì™•ì¡°ë“¤ì´ ë¶ìª½ì˜ í‰ë…¸ì™€ ê°™ì€ ë¶ë°© ìœ ëª© ë¯¼ì¡±ì˜ ì¹¨ì…ì„ ë§‰ê¸° ìœ„í•´ ê±´ì„¤í•œ ë°©ì–´ ì‹œì„¤ì…ë‹ˆë‹¤.' },
            { id: 'n3', question: 'ë…¸ë²¨ìƒì„ ìˆ˜ì—¬í•˜ëŠ” ë‚˜ë¼ëŠ” ì–´ë””ì¼ê¹Œìš”?', options: ['ë¯¸êµ­', 'ì˜êµ­', 'ìŠ¤ì›¨ë´', 'í”„ë‘ìŠ¤'], answerIndex: 2, difficulty: 'Normal', explanation: 'ë…¸ë²¨ìƒì€ ìŠ¤ì›¨ë´ì˜ ê³¼í•™ì ì•Œí”„ë ˆë“œ ë…¸ë²¨ì˜ ìœ ì–¸ì— ë”°ë¼ ìŠ¤ì›¨ë´ ì™•ë¦½ ê³¼í•™ì› ë“± ìŠ¤ì›¨ë´ ê¸°ê´€ê³¼ ë…¸ë¥´ì›¨ì´ ë…¸ë²¨ìœ„ì›íšŒê°€ ìˆ˜ì—¬í•©ë‹ˆë‹¤.' },
            { id: 'n4', question: 'ì¸ì²´ì˜ ë¼ˆ ì¤‘ ê°€ì¥ ê¸´ ë¼ˆëŠ” ë¬´ì—‡ì¼ê¹Œìš”?', options: ['ì‡„ê³¨', 'ê²½ê³¨', 'ëŒ€í‡´ê³¨', 'ì²™ì¶”'], answerIndex: 2, difficulty: 'Normal', explanation: 'ëŒ€í‡´ê³¨(Femur)ì€ í—ˆë²…ì§€ì— ìˆëŠ” ë¼ˆë¡œ, ì¸ì²´ì—ì„œ ê°€ì¥ í¬ê³  ê¸´ ë¼ˆì…ë‹ˆë‹¤.' },
            { id: 'n5', question: 'ì…°ìµìŠ¤í”¼ì–´ì˜ 4ëŒ€ ë¹„ê·¹ì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ì‘í’ˆì€ ë¬´ì—‡ì¼ê¹Œìš”?', options: ['í–„ë¦¿', 'ë¦¬ì–´ì™•', 'ë¡œë¯¸ì˜¤ì™€ ì¤„ë¦¬ì—£', 'ë§¥ë² ìŠ¤'], answerIndex: 2, difficulty: 'Normal', explanation: 'ì…°ìµìŠ¤í”¼ì–´ì˜ 4ëŒ€ ë¹„ê·¹ì€ í–„ë¦¿, ì˜¤ì…€ë¡œ, ë¦¬ì–´ì™•, ë§¥ë² ìŠ¤ì…ë‹ˆë‹¤. ë¡œë¯¸ì˜¤ì™€ ì¤„ë¦¬ì—£ì€ 5ëŒ€ ë¹„ê·¹ì— ì†í•˜ë‚˜ 4ëŒ€ ë¹„ê·¹ì—ëŠ” í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' },
            // Hard
            { id: 'h1', question: 'ì–‘ìì—­í•™ì—ì„œ ë¶ˆí™•ì •ì„± ì›ë¦¬ë¥¼ ì œì•ˆí•œ ê³¼í•™ìëŠ” ëˆ„êµ¬ì¼ê¹Œìš”?', options: ['ì•„ì¸ìŠˆíƒ€ì¸', 'ë³´ì–´', 'í•˜ì´ì  ë² ë¥´í¬', 'ìŠˆë¢°ë”©ê±°'], answerIndex: 2, difficulty: 'Hard', explanation: 'ë² ë¥´ë„ˆ í•˜ì´ì  ë² ë¥´í¬(Werner Heisenberg)ëŠ” ì…ìì˜ ìœ„ì¹˜ì™€ ìš´ë™ëŸ‰ì„ ë™ì‹œì— ì •í™•í•˜ê²Œ ì¸¡ì •í•  ìˆ˜ ì—†ë‹¤ëŠ” ë¶ˆí™•ì •ì„± ì›ë¦¬ë¥¼ ì œì•ˆí–ˆìŠµë‹ˆë‹¤.' },
            { id: 'h2', question: 'ê³ ëŒ€ ë¡œë§ˆì˜ ìœ¨ë¦¬ìš°ìŠ¤ ì¹´ì´ì‚¬ë¥´ê°€ ë‚¨ê¸´ ìœ ëª…í•œ ë§ "ì™”ë…¸ë¼, ë³´ì•˜ë…¸ë¼, ì´ê²¼ë…¸ë¼"ì˜ ë¼í‹´ì–´ ì›ë¬¸ì€ ë¬´ì—‡ì¼ê¹Œìš”?', options: ['Carpe Diem', 'Veni, Vidi, Vici', 'Alea iacta est', 'Et tu, Brute?'], answerIndex: 1, difficulty: 'Hard', explanation: '"Veni, Vidi, Vici"ëŠ” ì¹´ì´ì‚¬ë¥´ê°€ ê¸°ì›ì „ 47ë…„ ì ¤ë¼ ì „íˆ¬ì—ì„œ ìŠ¹ë¦¬í•œ í›„ ë¡œë§ˆì— ë³´ë‚¸ ë³´ê³ ì„œì— ì“´ ë¬¸êµ¬ë¡œ ì•Œë ¤ì ¸ ìˆìŠµë‹ˆë‹¤.' },
            { id: 'h3', question: 'ê²½ì œí•™ì—ì„œ "ë³´ì´ì§€ ì•ŠëŠ” ì†" ê°œë…ì„ ì œì‹œí•œ í•™ìëŠ” ëˆ„êµ¬ì¼ê¹Œìš”?', options: ['ì¡´ ë©”ì´ë„ˆë“œ ì¼€ì¸ìŠ¤', 'ì¹¼ ë§ˆë¥´í¬ìŠ¤', 'ì• ë¤ ìŠ¤ë¯¸ìŠ¤', 'ë°€í„´ í”„ë¦¬ë“œë¨¼'], answerIndex: 2, difficulty: 'Hard', explanation: 'ì• ë¤ ìŠ¤ë¯¸ìŠ¤(Adam Smith)ëŠ” êµ­ë¶€ë¡ (The Wealth of Nations)ì—ì„œ ì‹œì¥ ê²½ì œê°€ ê°œì¸ì˜ ì´ê¸°ì‹¬ì— ì˜í•´ ì¡°ì •ëœë‹¤ëŠ” "ë³´ì´ì§€ ì•ŠëŠ” ì†" ê°œë…ì„ ì œì‹œí–ˆìŠµë‹ˆë‹¤.' },
            { id: 'h4', question: '1905ë…„ ì•„ì¸ìŠˆíƒ€ì¸ì´ ë°œí‘œí•œ 4í¸ì˜ ë…¼ë¬¸ì€ ê¸°ì ì˜ í•´ ë…¼ë¬¸(Annus Mirabilis Papers)ì´ë¼ ë¶ˆë¦½ë‹ˆë‹¤. ì´ ë…¼ë¬¸ë“¤ì— í¬í•¨ë˜ì§€ ì•ŠëŠ” ì£¼ì œëŠ” ë¬´ì—‡ì¼ê¹Œìš”?', options: ['ê´‘ì „ íš¨ê³¼', 'ë¸Œë¼ìš´ ìš´ë™', 'íŠ¹ìˆ˜ ìƒëŒ€ì„± ì´ë¡ ', 'ì–‘ìì¥ ì´ë¡ '], answerIndex: 3, difficulty: 'Hard', explanation: 'ì•„ì¸ìŠˆíƒ€ì¸ì˜ 1905ë…„ ë…¼ë¬¸ì€ ê´‘ì „ íš¨ê³¼, ë¸Œë¼ìš´ ìš´ë™, íŠ¹ìˆ˜ ìƒëŒ€ì„± ì´ë¡ , ê·¸ë¦¬ê³  ì§ˆëŸ‰-ì—ë„ˆì§€ ë“±ê°€ì„±(E=mcÂ²)ì„ ë‹¤ë£¨ì—ˆìœ¼ë©°, ì–‘ìì¥ ì´ë¡ ì€ ì´í›„ì— ë°œì „í•œ ê°œë…ì…ë‹ˆë‹¤.' },
            { id: 'h5', question: 'í”„ë‘ìŠ¤ í˜ëª…ì˜ êµ¬í˜¸ì¸ "ììœ , í‰ë“±, ë°•ì• " ì¤‘ "ë°•ì• "ì— í•´ë‹¹í•˜ëŠ” í”„ë‘ìŠ¤ì–´ ë‹¨ì–´ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?', options: ['LibertÃ©', 'Ã‰galitÃ©', 'FraternitÃ©', 'Justice'], answerIndex: 2, difficulty: 'Hard', explanation: 'í”„ë‘ìŠ¤ í˜ëª…ì˜ êµ¬í˜¸ëŠ” LibertÃ©(ììœ ), Ã‰galitÃ©(í‰ë“±), FraternitÃ©(ë°•ì• )ì…ë‹ˆë‹¤.' },
        ];


        // =========================================================================
        // 3. Firebase Firestore ë° ì¸ì¦ (Auth)
        // =========================================================================

        /** @description LocalStorageì— í€´ì¦ˆ íˆìŠ¤í† ë¦¬ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. (ë¹„ì¸ê°€/ìµëª… ì‚¬ìš©ììš©) */
        function saveQuizHistory(history) {
            localStorage.setItem(`quizHistory_${userId}`, JSON.stringify(history));
            console.log("Quiz History saved to LocalStorage:", history.length);
        }
        
        /** @description Firebase ì¸ì¦ ë° Firestoreë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. */
        async function initializeFirebase() {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } else {
                console.error("Firebase config is missing.");
                // ë¹„ì¸ê°€ ëª¨ë“œì—ì„œë„ ì‹¤í–‰ë˜ë„ë¡ ë”ë¯¸ ê°ì²´ í• ë‹¹
                auth = { currentUser: { uid: 'anonymous-' + Math.random().toString(36).substring(2, 9) } };
                userId = auth.currentUser.uid;
                startListeningToHistory();
                renderMainMenu();
                return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth error:", error);
                // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ìµëª… ì‚¬ìš©ì IDë¥¼ ëŒ€ì²´ ì‚¬ìš©
                auth.currentUser = { uid: 'error-' + Math.random().toString(36).substring(2, 9) };
            }
            
            // ì¸ì¦ ìƒíƒœ ë³€í™” ë¦¬ìŠ¤ë„ˆ
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // onAuthStateChangedê°€ ë°œìƒí–ˆìœ¼ë‚˜ userê°€ nullì¸ ê²½ìš° ìµëª… ID ë¶€ì—¬
                    userId = auth.currentUser?.uid || 'anon-' + Math.random().toString(36).substring(2, 9);
                }
                console.log("User ID set:", userId);
                startListeningToHistory(); // ì¸ì¦ì´ ì™„ë£Œë˜ë©´ íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                renderMainMenu(); // ë©”ì¸ ë©”ë‰´ ë Œë”ë§
            });
        }
        
        /** @description Firestoreì—ì„œ í€´ì¦ˆ íˆìŠ¤í† ë¦¬ ë³€ê²½ ì‚¬í•­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ í•˜ê±°ë‚˜ LocalStorageì—ì„œ ë¡œë“œí•©ë‹ˆë‹¤. */
        function startListeningToHistory() {
            if (!db || userId === 'loading' || userId.startsWith('error-') || userId.startsWith('anon-') || userId.startsWith('anonymous-')) {
                 // íŒŒì´ì–´ë² ì´ìŠ¤ê°€ ì—†ê±°ë‚˜, ìµëª… ë˜ëŠ” ì—ëŸ¬ ìœ ì €ì¸ ê²½ìš° LocalStorageì—ì„œ ë¡œë“œ
                console.warn("Firestore history listening skipped. Loading from LocalStorage.");
                quizHistory = JSON.parse(localStorage.getItem(`quizHistory_${userId}`)) || [];
                // ë¡œë“œ í›„ ì¦‰ì‹œ ì •ë ¬ (ê°€ì¥ ìµœê·¼ í•­ëª©ì´ ì•ìœ¼ë¡œ ì˜¤ë„ë¡)
                quizHistory.sort((a, b) => b.timestamp - a.timestamp);
                return; 
            }

            const historyCollectionPath = `/artifacts/${appId}/users/${userId}/quizHistory`;
            const q = query(collection(db, historyCollectionPath));

            onSnapshot(q, (snapshot) => {
                const history = [];
                snapshot.forEach((doc) => {
                    history.push(doc.data());
                });
                // ê°€ì¥ ìµœê·¼ì˜ 50ê°œ í•­ëª©ë§Œ ìœ ì§€ (ì„±ëŠ¥ì„ ìœ„í•´)
                history.sort((a, b) => b.timestamp - a.timestamp);
                quizHistory = history.slice(0, 50); 
                // ë©”ì¸ ë©”ë‰´ì— ë³€ê²½ ì‚¬í•­ ë°˜ì˜
                if (document.getElementById('content-title')?.innerText === 'ë©”ì¸ ë©”ë‰´') {
                    renderMainMenu();
                }
                console.log("Quiz History updated from Firestore:", quizHistory.length);
            }, (error) => {
                console.error("Error listening to history:", error);
            });
        }
        
        /** @description í€´ì¦ˆ ê²°ê³¼ë¥¼ Firestore ë˜ëŠ” LocalStorageì— ì €ì¥í•©ë‹ˆë‹¤. */
        async function saveQuizResult(quizId, isCorrect, difficulty) {
            const newEntry = {
                quizId,
                isCorrect,
                difficulty,
                timestamp: Date.now()
            };
            
            if (db && userId && !userId.startsWith('error-') && !userId.startsWith('anon-') && !userId.startsWith('anonymous-')) {
                // Firestoreì— ì €ì¥
                const historyCollectionPath = `/artifacts/${appId}/users/${userId}/quizHistory`;
                try {
                    // IDëŠ” 'difficulty_timestamp' í˜•íƒœë¡œ ì €ì¥í•˜ì—¬ ê³ ìœ ì„± í™•ë³´
                    const docId = `${difficulty}_${Date.now()}_${Math.random().toString(36).substring(2, 6)}`;
                    await setDoc(doc(db, historyCollectionPath, docId), newEntry);
                } catch (error) {
                    console.error("Error saving to Firestore:", error);
                }
            } else {
                // LocalStorageì— ì €ì¥ (ìµëª… ë˜ëŠ” ì—ëŸ¬ ì‚¬ìš©ì)
                quizHistory.unshift(newEntry); // ìµœì‹  í•­ëª©ì„ ì•ì— ì¶”ê°€
                quizHistory = quizHistory.slice(0, 50); // ìµœëŒ€ 50ê°œ í•­ëª© ìœ ì§€
                saveQuizHistory(quizHistory); // LocalStorageì— ëª…ì‹œì ìœ¼ë¡œ ì €ì¥
            }
        }


        // =========================================================================
        // 4. UI ë Œë”ë§ ë° ë¡œì§
        // =========================================================================

        /** @description ë©”ì¸ ë©”ë‰´ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */
        window.renderMainMenu = () => {
            if (timerInterval) clearInterval(timerInterval);
            currentQuizSet = [];
            currentQuizIndex = 0;

            const reviewItems = quizHistory.filter(h => !h.isCorrect).length;
            const totalPlayed = quizHistory.length;
            const correctCount = quizHistory.filter(h => h.isCorrect).length;
            const accuracy = totalPlayed > 0 ? ((correctCount / totalPlayed) * 100).toFixed(1) : 0;

            contentDiv.innerHTML = `
                <div id="content-title" class="text-2xl font-semibold mb-6 text-center text-white">ë©”ì¸ ë©”ë‰´</div>
                
                <!-- í˜„ì¬ ìƒíƒœ ì¹´ë“œ -->
                <div class="bg-[#2e2e4d] p-6 rounded-xl shadow-lg mb-6">
                    <p class="text-xl font-bold mb-3 text-white">ë‚´ í€´ì¦ˆ ê¸°ë¡</p>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="text-sm text-gray-400">ì´ í‘¼ ë¬¸ì œ</p>
                            <p class="text-2xl font-extrabold text-indigo-400">${totalPlayed}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">ì •ë‹µë¥ </p>
                            <p class="text-2xl font-extrabold text-green-400">${accuracy}%</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">ë³µìŠµ í•„ìš”</p>
                            <p class="text-2xl font-extrabold text-red-400">${reviewItems}</p>
                        </div>
                    </div>
                </div>

                <!-- ë‚œì´ë„ ì„ íƒ -->
                <p class="text-xl font-bold mb-4 text-white">ìƒˆ í€´ì¦ˆ ì‹œì‘ (10ë¬¸ì œ)</p>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    ${['Easy', 'Normal', 'Hard'].map(diff => `
                        <button 
                            class="gradient-button py-3 rounded-xl text-lg shadow-md hover:shadow-xl" 
                            onclick="startNewQuiz('${diff}')">
                            ${diff}
                        </button>
                    `).join('')}
                </div>

                <!-- ë³µìŠµ ëª¨ë“œ ë²„íŠ¼ -->
                ${reviewItems > 0 ? `
                    <p class="text-xl font-bold mb-4 text-white">ì˜¤ë‹µ ë³µìŠµ</p>
                    <button 
                        class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" 
                        onclick="startReviewMode()">
                        í‹€ë¦° ë¬¸ì œ ë³µìŠµí•˜ê¸° (${reviewItems}ê°œ)
                    </button>
                ` : `
                    <div class="text-center p-4 text-gray-400 bg-[#2e2e4d] rounded-xl">
                        <p>í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì™„ë²½í•´ìš”!</p>
                    </div>
                `}
            `;
        };
        
        /** @description í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. */
        window.startNewQuiz = (difficulty) => {
            selectedDifficulty = difficulty;
            quizzes = mockQuizzes.filter(q => q.difficulty === difficulty);
            
            // 10ë¬¸ì œ ëœë¤ ì¶”ì¶œ
            const shuffled = quizzes.sort(() => 0.5 - Math.random());
            currentQuizSet = shuffled.slice(0, 10);
            currentQuizIndex = 0;
            
            // í€´ì¦ˆ ì‹œì‘
            if (currentQuizSet.length > 0) {
                renderQuizQuestion();
            } else {
                contentDiv.innerHTML = `<p class="text-center text-red-400">í•´ë‹¹ ë‚œì´ë„ì˜ í€´ì¦ˆê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>`;
            }
        };

        /** @description í˜„ì¬ í€´ì¦ˆ ë¬¸ì œë¥¼ ë Œë”ë§í•˜ê³  íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. */
        function renderQuizQuestion() {
            if (currentQuizIndex >= currentQuizSet.length) {
                endQuiz();
                return;
            }

            const currentQuiz = currentQuizSet[currentQuizIndex];
            timeRemaining = 15; // íƒ€ì´ë¨¸ ì´ˆê¸°í™”

            // íƒ€ì´ë¨¸ ì •ë¦¬ í›„ ì¬ì‹œì‘
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                document.getElementById('quiz-timer').innerText = timeRemaining.toString().padStart(2, '0');
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(null, currentQuiz.answerIndex); // ì‹œê°„ ì´ˆê³¼ ì²˜ë¦¬
                }
            }, 1000);

            contentDiv.innerHTML = `
                <div class="quiz-card w-full p-6 shadow-2xl">
                    <!-- í—¤ë” -->
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-[#3e3e5d]">
                        <h2 class="text-xl font-semibold text-indigo-400">
                            ëœë¤ ìƒì‹ í€´ì¦ˆ (ë‚œì´ë„: ${selectedDifficulty})
                        </h2>
                        <div class="flex space-x-4">
                            <span class="text-lg font-bold text-gray-300">${currentQuizIndex + 1} / ${currentQuizSet.length}</span>
                            <span id="quiz-timer" class="text-lg font-bold text-red-400">15</span>
                        </div>
                    </div>

                    <!-- í€´ì¦ˆ ë‚´ìš© -->
                    <div class="quiz-content p-4 rounded-xl bg-[#2e2e4d] mb-6 min-h-[120px] flex items-center justify-center text-center">
                        <p id="quiz-question" class="text-2xl font-bold text-yellow-300 break-words">
                            ${currentQuiz.question}
                        </p>
                    </div>
                    
                    <!-- ì˜µì…˜ ë²„íŠ¼ -->
                    <div id="quiz-options" class="grid grid-cols-1 gap-4">
                        ${currentQuiz.options.map((option, index) => `
                            <button 
                                class="option-button w-full py-3 rounded-xl text-md shadow-md text-left px-4"
                                onclick="handleAnswer(this, ${index})">
                                ${index + 1}. ${option}
                            </button>
                        `).join('')}
                    </div>
                    <!-- í•´ì„¤ ì˜ì—­ (ì´ˆê¸°ì—ëŠ” ë¹„ì–´ ìˆìŒ) -->
                    <div id="quiz-explanation" class="mt-6 hidden"></div>
                </div>
            `;
        }
        
        /** * @description ì •ë‹µì„ í™•ì¸í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. 
         * @param {HTMLElement|null} selectedButton - ì‚¬ìš©ìê°€ í´ë¦­í•œ ë²„íŠ¼
         * @param {number} selectedIndex - ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¸ë±ìŠ¤ (ì‹œê°„ ì´ˆê³¼ ì‹œ null)
         */
        window.handleAnswer = (selectedButton, selectedIndex) => {
            if (timerInterval) clearInterval(timerInterval); // íƒ€ì´ë¨¸ ì¤‘ì§€
            
            const optionsDiv = document.getElementById('quiz-options');
            const buttons = optionsDiv.querySelectorAll('button');
            const currentQuiz = currentQuizSet[currentQuizIndex];
            const isCorrect = selectedIndex === currentQuiz.answerIndex;
            
            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
            buttons.forEach(btn => btn.disabled = true);
            
            // UI ì—…ë°ì´íŠ¸ ë° ê¸°ë¡ ì €ì¥
            buttons.forEach((btn, index) => {
                const isSelected = index === selectedIndex;
                const isAnswer = index === currentQuiz.answerIndex;

                if (isAnswer) {
                    btn.classList.add('correct');
                    btn.innerHTML += ' &check; ì •ë‹µ';
                } else if (isSelected && !isAnswer) {
                    btn.classList.add('incorrect');
                    btn.innerHTML += ' &times; ì˜¤ë‹µ';
                } else {
                    btn.classList.add('faded-out');
                }
            });
            
            // í•´ì„¤ ë Œë”ë§ **(ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„)**
            const explanationDiv = document.getElementById('quiz-explanation');
            explanationDiv.classList.remove('hidden');
            explanationDiv.innerHTML = `
                <div class="bg-[#3e3e5d] p-4 rounded-xl">
                    <p class="text-lg font-bold text-indigo-300 mb-2">ğŸ’¡ í•´ì„¤</p>
                    <p class="text-gray-200">${currentQuiz.explanation}</p>
                </div>
            `;
            
            // ê²°ê³¼ ì €ì¥
            saveQuizResult(currentQuiz.id, isCorrect, currentQuiz.difficulty);
            
            // ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ ì¶”ê°€
            const nextButton = document.createElement('button');
            nextButton.className = 'gradient-button w-full py-3 rounded-xl text-lg shadow-lg mt-6';
            nextButton.innerText = 'ë‹¤ìŒ ë¬¸ì œë¡œ';
            nextButton.onclick = () => {
                currentQuizIndex++;
                renderQuizQuestion();
            };
            optionsDiv.parentNode.appendChild(nextButton);
        }

        /** @description í€´ì¦ˆë¥¼ ì¢…ë£Œí•˜ê³  ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. */
        function endQuiz() {
            if (timerInterval) clearInterval(timerInterval);
            
            const total = currentQuizSet.length;
            // í€´ì¦ˆ ì„¸íŠ¸ì˜ IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë‹µ/ì˜¤ë‹µì„ ê³„ì‚°í•©ë‹ˆë‹¤.
            const quizSetIds = currentQuizSet.map(q => q.id);
            const recentHistory = quizHistory.filter(h => quizSetIds.includes(h.quizId));
            const correctAnswers = recentHistory.filter(h => h.isCorrect && quizSetIds.includes(h.quizId)).length;
            const score = correctAnswers / total;

            contentDiv.innerHTML = `
                <div class="quiz-card w-full text-center p-8 shadow-2xl">
                    <p class="text-4xl font-extrabold mb-4 ${score >= 0.7 ? 'text-green-400' : 'text-red-400'}">
                        í€´ì¦ˆ ì™„ë£Œ!
                    </p>
                    <p class="text-2xl font-bold mb-2">
                        ${correctAnswers} / ${total} ì •ë‹µ
                    </p>
                    <p class="text-xl mb-8 text-gray-300">
                        ì •ë‹µë¥ : ${(score * 100).toFixed(1)}%
                    </p>
                    
                    <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" onclick="renderMainMenu()">
                        ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
        }

        // =========================================================================
        // 5. ë³µìŠµ ëª¨ë“œ
        // =========================================================================

        let reviewSet = []; // ë³µìŠµ ë¬¸ì œ ëª©ë¡ (Quiz ê°ì²´ë¡œ êµ¬ì„±)

        /** @description ë³µìŠµ ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. */
        window.startReviewMode = () => {
            if (timerInterval) clearInterval(timerInterval);
            
            // í‹€ë¦° ë¬¸ì œì˜ quizId ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const incorrectQuizIds = [...new Set(quizHistory
                .filter(h => !h.isCorrect)
                .map(h => h.quizId)
            )];

            // ì „ì²´ í€´ì¦ˆ ëª©ë¡ì—ì„œ í•´ë‹¹ IDì˜ ë¬¸ì œë§Œ í•„í„°ë§í•©ë‹ˆë‹¤.
            const allQuizzes = [...mockQuizzes];
            reviewSet = allQuizzes.filter(quiz => incorrectQuizIds.includes(quiz.id));

            if (reviewSet.length === 0) {
                // ì´ë¯¸ ë³µìŠµì´ ì™„ë£Œë˜ì–´ í‹€ë¦° ë¬¸ì œê°€ ì—†ëŠ” ê²½ìš°
                endReview(); 
                return;
            }
            
            // ë³µìŠµ ëª¨ë“œëŠ” ì„ì§€ ì•Šê³ , ë°°ì—´ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.
            currentQuizIndex = 0;
            renderReviewQuestion();
        };

        /** @description í˜„ì¬ ë³µìŠµ ë¬¸ì œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */
        function renderReviewQuestion() {
            if (currentQuizIndex >= reviewSet.length) {
                endReview();
                return;
            }

            const currentQuiz = reviewSet[currentQuizIndex];
            const totalReview = reviewSet.length;

            contentDiv.innerHTML = `
                <div class="quiz-card w-full p-6 shadow-2xl">
                    <!-- í—¤ë” -->
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-[#3e3e5d]">
                        <h2 class="text-xl font-semibold text-red-400">
                            ì˜¤ë‹µ ë³µìŠµ ëª¨ë“œ
                        </h2>
                        <span class="text-lg font-bold text-gray-300">${currentQuizIndex + 1} / ${totalReview}</span>
                    </div>

                    <!-- í€´ì¦ˆ ë‚´ìš© -->
                    <div class="quiz-content p-4 rounded-xl bg-[#2e2e4d] mb-6 min-h-[120px] flex items-center justify-center text-center">
                        <p id="quiz-question" class="text-2xl font-bold text-yellow-300 mb-4 break-words">
                            ${currentQuiz.question}
                        </p>
                    </div>
                    
                    <!-- ì •ë‹µ ë° í•´ì„¤ í‘œì‹œ (ë³µìŠµ ëª¨ë“œ UI ì—…ë°ì´íŠ¸) -->
                    <div class="bg-[#3e3e5d] p-4 rounded-xl mb-6">
                        <p class="text-lg font-bold text-green-400 mb-2">âœ… ì •ë‹µ: ${currentQuiz.options[currentQuiz.answerIndex]}</p>
                        <p class="text-lg font-bold text-indigo-300 mt-4 mb-2">ğŸ’¡ í•´ì„¤</p>
                        <p class="text-gray-200">${currentQuiz.explanation}</p>
                    </div>

                    <!-- ë²„íŠ¼ -->
                    <div class="grid grid-cols-2 gap-4">
                        <button class="option-button w-full py-3 rounded-xl text-lg shadow-md"
                            onclick="window.removeReviewItem('${currentQuiz.id}')">
                            ì™„ë²½íˆ ì´í•´í–ˆì–´ìš”! (ì œê±°)
                        </button>
                        <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-md"
                            onclick="window.nextReviewQuestion()">
                            ë‹¤ìŒ ë¬¸ì œë¡œ
                        </button>
                    </div>
                </div>
            `;
        }

        /** @description ë‹¤ìŒ ë³µìŠµ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤. */
        window.nextReviewQuestion = () => {
            currentQuizIndex++;
            renderReviewQuestion();
        };
        
        /** @description ë³µìŠµ ëª©ë¡ì—ì„œ í•´ë‹¹ ë¬¸ì œë¥¼ ì œê±°í•˜ê³  íˆìŠ¤í† ë¦¬ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. */
        window.removeReviewItem = (quizId) => {
            // 1. ë¡œì»¬ íˆìŠ¤í† ë¦¬ì—ì„œ í•´ë‹¹ ë¬¸ì œì˜ ì˜¤ë‹µ ê¸°ë¡ë§Œ ì œê±°
            quizHistory = quizHistory.filter(h => !(h.quizId === quizId && !h.isCorrect));

            if (db && userId && !userId.startsWith('error-') && !userId.startsWith('anon-') && !userId.startsWith('anonymous-')) {
                // Firestore í™˜ê²½ (ì—¬ê¸°ëŠ” ë¡œì»¬ ìƒíƒœë§Œ ë³€ê²½)
            } else {
                 // LocalStorageì— ëª…ì‹œì ìœ¼ë¡œ ì €ì¥ (ë°ì´í„° ë³´ì¡´)
                saveQuizHistory(quizHistory);
            }
            
            // 2. í˜„ì¬ ë³µìŠµ ì…‹ì—ì„œ í•´ë‹¹ ë¬¸ì œ ì œê±°
            reviewSet = reviewSet.filter(q => q.id !== quizId);
            
            // 3. ì¸ë±ìŠ¤ ì¡°ì • (ì œê±° í›„ ë‹¤ìŒ ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡)
            if (currentQuizIndex >= reviewSet.length && reviewSet.length > 0) {
                // ë§ˆì§€ë§‰ ë¬¸ì œë¥¼ ì œê±°í–ˆì„ ê²½ìš° ì¸ë±ìŠ¤ë¥¼ ì´ì „ìœ¼ë¡œ ë˜ëŒë¦¼
                currentQuizIndex = Math.max(0, reviewSet.length - 1);
            } else if (reviewSet.length === 0) {
                 // ëª¨ë“  ë¬¸ì œê°€ ì œê±°ëœ ê²½ìš° (endReview()ê°€ ì²˜ë¦¬í•¨)
            } 
            // 4. ë‹¤ìŒ ë¬¸ì œ ë Œë”ë§
            renderReviewQuestion();
        };

        /** @description ë³µìŠµ ëª¨ë“œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. */
        function endReview() {
            // íƒ€ì´ë¨¸ ì •ë¦¬
            if (timerInterval) clearInterval(timerInterval);

            contentDiv.innerHTML = `
                <div class="quiz-card w-full text-center p-8 shadow-2xl">
                    <p class="text-4xl font-extrabold mb-4 text-green-400">ë³µìŠµ ì™„ë£Œ!</p>
                    <p class="text-xl mb-8">
                        í‹€ë ¸ë˜ ëª¨ë“  ë¬¸ì œë¥¼ í™•ì¸í•˜ì…¨ìŠµë‹ˆë‹¤.
                    </p>
                    
                    <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" onclick="renderMainMenu()">
                        ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
        }
        
        // =========================================================================
        // 6. ì´ˆê¸° ë¡œë“œ
        // =========================================================================

        initializeFirebase();
        
    </script>
</body>
</html>