<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëœë¤ ìƒì‹ í€´ì¦ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Tailwind default) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e1e2d; /* ì§™ì€ ë°°ê²½ */
            color: #e0e0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* ë¸”ëŸ¬ íš¨ê³¼ë¥¼ ìœ„í•œ ë°°ê²½ ì»¨í…Œì´ë„ˆ */
        #app-container {
            background: rgba(30, 30, 50, 0.7); /* ë¶ˆíˆ¬ëª…í•œ ë°°ê²½ */
            backdrop-filter: blur(10px); /* ë¸”ëŸ¬ íš¨ê³¼ */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 600px;
            padding: 30px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ë³´ë¼-ì—°ë‘ ê·¸ë¼ë°ì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .gradient-button {
            background-image: linear-gradient(135deg, #a78bfa 0%, #4ade80 100%); /* ë³´ë¼ìƒ‰ -> ì—°ë‘ìƒ‰ */
            transition: all 0.3s ease;
            color: #1e1e2d;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(167, 139, 250, 0.4);
        }
        .gradient-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 222, 128, 0.5);
        }
        .gradient-button:disabled {
            background-image: none;
            background-color: #4a5568; /* Gray-700 */
            cursor: not-allowed;
            box-shadow: none;
            color: #a0aec0;
        }

        /* í€´ì¦ˆ ì¹´ë“œ ë””ìì¸ */
        .quiz-card {
            background: rgba(45, 45, 70, 0.9);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        /* í€´ì¦ˆ ì˜µì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .quiz-option-button {
            background-color: #374151; /* bg-gray-700 */
            color: #e0e0f0; /* text-white */
            border: 1px solid transparent;
            text-align: left;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .quiz-option-button:hover:not([disabled]) {
            background-color: #8b5cf6; /* hover:bg-purple-600 */
            border-color: #a78bfa;
        }

        /* íƒ€ì´ë¨¸ ìˆ«ìì— ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ ì ìš©ì„ ìœ„í•œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        #quiz-timer {
            transition: color 0.5s ease-in-out, filter 0.5s ease-in-out;
        }

        /* ì‹ ê·œ ì• ë‹ˆë©”ì´ì…˜: ë‚´ë ¤ì˜¤ê¸° + ë°ê²Œ */
        @keyframes timer-tick {
            0% {
                opacity: 0.5;
                transform: translateY(-10px) scale(0.9); /* ìœ„ì—ì„œ ì‹œì‘ */
                filter: brightness(1.5); /* ë°ê²Œ */
            }
            50% {
                opacity: 1;
                transform: translateY(0) scale(1.1); /* ì¤‘ì•™ìœ¼ë¡œ ë‚´ë ¤ì˜¤ë©´ì„œ ì•½ê°„ ì»¤ì§€ê³  */
                filter: brightness(2.5); /* ê°€ì¥ ë°ê²Œ */
            }
            100% {
                transform: translateY(0) scale(1.0);
                filter: brightness(1.0); /* ì›ë˜ ë°ê¸°ë¡œ ë³µê·€ */
            }
        }
        
        .timer-animate {
            animation: timer-tick 0.5s ease-out forwards;
        }
    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore ë¡œê¹… í™œì„±í™” (ë””ë²„ê¹… ìš©)
        setLogLevel('Debug');

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        window.db = null;
        window.auth = null;
        window.userId = null;
        
        // ìº”ë²„ìŠ¤ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© (Vercelì—ì„œëŠ” ì´ ê°’ì´ nullì´ê±°ë‚˜ ì •ì˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * @description Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        async function initializeFirebase() {
            // Vercel í™˜ê²½ì—ì„œëŠ” firebaseConfigê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì˜ˆì™¸ ì²˜ë¦¬
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.warn("Firebase config is missing or invalid. Firebase features (multi-user sync) will be disabled. Falling back to LocalStorage.");
                
                // Canvas í™˜ê²½ì´ì—ˆëŠ”ë° ì‹¤íŒ¨í•œ ê²½ìš° (ì—¬ê¸°ì„œëŠ” ì•Œë¦¼ì„ ë„ê³ , ì½˜ì†” ê²½ê³ ë§Œ ë‚¨ê¹ë‹ˆë‹¤.)
                // if (typeof __firebase_config !== 'undefined') {
                //     window.showNotification('âš ï¸ ê²½ê³ : Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.', 'info', true);
                // }
                
                window.checkAndInitializeQuiz();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", window.userId);
                    } else {
                        // ì´ˆê¸° í† í°ì´ ìˆìœ¼ë©´ ì»¤ìŠ¤í…€ ì¸ì¦, ì—†ìœ¼ë©´ ìµëª… ì¸ì¦ ì‹œë„
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    }
                    // ì¸ì¦ ìƒíƒœê°€ í™•ì •ëœ í›„ ë©”ì¸ ë©”ë‰´ ë Œë”ë§ ì‹œì‘
                    window.checkAndInitializeQuiz();
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                window.showNotification('ì‹œìŠ¤í…œ ì˜¤ë¥˜: Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œì»¬ ì €ì¥ì†Œë¡œ ì‘ë™í•©ë‹ˆë‹¤.', 'error');
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í€´ì¦ˆ ê¸°ëŠ¥ì€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ë™í•˜ë„ë¡ ì‹œë„
                window.checkAndInitializeQuiz(); 
            }
        }

        // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
        window.onload = initializeFirebase;
    </script>
</head>
<body>

<div id="app-container">
    <h1 class="text-3xl font-bold mb-8 text-white">ëœë¤ ìƒì‹ í€´ì¦ˆ</h1>

    <div id="content" class="w-full flex flex-col items-center">
        <!-- ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ (ë©”ì¸ ë©”ë‰´, í€´ì¦ˆ, ë³µìŠµ ë“±) -->
    </div>

    <!-- ë¡œë”© ë° ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="notification-area" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 backdrop-blur-sm hidden flex justify-center items-center z-50">
        <div id="notification-box" class="quiz-card p-6 text-center shadow-2xl">
            <p id="notification-message" class="text-xl font-semibold"></p>
            <div id="loading-spinner" class="mt-4 animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-purple-400 mx-auto hidden"></div>
            <button id="notification-ok-button" class="gradient-button mt-6 py-2 px-6 rounded-full text-sm hidden" onclick="window.hideNotification()">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
    // =========================================================================
    // 1. ì „ì—­ ì„¤ì • ë° ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // =========================================================================

    const QUIZ_TOPICS = [
        'ë””ì§€í„¸ ë¦¬í„°ëŸ¬ì‹œ', 'í™˜ê²½', 'ê³¼í•™', 'ì •ì¹˜', 'ê²½ì œ', 'ì‚¬íšŒ', 
        'êµ­ì–´ ë§ì¶¤ë²•', 'êµ­ì–´ ì†ë‹´', 'ì§€ë¦¬', 'ì—­ì‚¬'
    ];
    const LOCAL_STORAGE_QUIZ_KEY = 'accumulated_quiz_data';
    const LOCAL_STORAGE_HISTORY_KEY = 'quiz_history';
    const LOCAL_STORAGE_DATE_KEY = 'last_generated_date';
    const LOCAL_STORAGE_API_KEY = 'gemini_api_key'; 
    const contentDiv = document.getElementById('content');
    
    // íƒ€ì´ë¨¸ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
    let timerInterval = null;
    const TIME_LIMIT = 15;
    
    let accumulatedQuizzes = [];
    let quizHistory = [];
    let currentQuizSet = [];
    let quizMode = 'menu'; 
    let currentQuestionIndex = 0;


    /** @description UUIDë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ëœë¤ ID) */
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    /** @description ë°°ì—´ì„ ì„ìŠµë‹ˆë‹¤. (Fisher-Yates ì•Œê³ ë¦¬ì¦˜) */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = array[j], array[i];
        }
        return array;
    }

    /**
     * @description ì•Œë¦¼ ë©”ì‹œì§€ ë˜ëŠ” ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
     * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
     * @param {'loading'|'info'|'error'} type - ë©”ì‹œì§€ ìœ í˜•
     * @param {boolean} [showButton=false] - í™•ì¸ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
     */
    window.showNotification = (message, type, showButton = false) => {
        const area = document.getElementById('notification-area');
        const msg = document.getElementById('notification-message');
        const spinner = document.getElementById('loading-spinner');
        const button = document.getElementById('notification-ok-button');

        msg.textContent = message;
        spinner.classList.add('hidden');
        button.classList.add('hidden');

        if (type === 'loading') {
            spinner.classList.remove('hidden');
        } else if (showButton || type === 'error' || type === 'info') {
            button.classList.remove('hidden');
        }
        
        // ë°°ê²½ìƒ‰ ë° ìŠ¤íƒ€ì¼ ì¡°ì • (ì„ íƒì )
        const box = document.getElementById('notification-box');
        if (type === 'error') {
            box.style.borderColor = '#ef4444'; // Red
        } else {
            box.style.borderColor = 'rgba(167, 139, 250, 0.3)';
        }

        area.classList.remove('hidden');
    };

    /** @description ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ì„ ìˆ¨ê¹ë‹ˆë‹¤. */
    window.hideNotification = () => {
        document.getElementById('notification-area').classList.add('hidden');
    };

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. */
    function loadQuizData() {
        try {
            const data = localStorage.getItem(LOCAL_STORAGE_QUIZ_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
            return [];
        }
    }

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í€´ì¦ˆ ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. */
    function saveQuizData(data) {
        try {
            localStorage.setItem(LOCAL_STORAGE_QUIZ_KEY, JSON.stringify(data));
        } catch (e) {
            console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í€´ì¦ˆ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:", e);
        }
    }

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. */
    function loadQuizHistory() {
        try {
            const data = localStorage.getItem(LOCAL_STORAGE_HISTORY_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í€´ì¦ˆ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:", e);
            return [];
        }
    }

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í€´ì¦ˆ íˆìŠ¤í† ë¦¬ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. */
    function saveQuizHistory(data) {
        try {
            localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(data));
        } catch (e) {
            console.error("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í€´ì¦ˆ íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:", e);
        }
    }
    
    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ API í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. */
    function getApiKey() {
        return localStorage.getItem(LOCAL_STORAGE_API_KEY) || '';
    }

    /** @description ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— API í‚¤ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. */
    window.saveApiKey = (key) => {
        const trimmedKey = key.trim();
        localStorage.setItem(LOCAL_STORAGE_API_KEY, trimmedKey);
        renderMainMenu(); // í‚¤ ì €ì¥ í›„ ë©”ì¸ ë©”ë‰´ ìƒˆë¡œê³ ì¹¨
        if (trimmedKey) {
            window.showNotification('ğŸ”‘ API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ í€´ì¦ˆë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info', true);
        } else {
             window.showNotification('ğŸ”‘ API í‚¤ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. í€´ì¦ˆ ìƒì„± ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.', 'info', true);
        }
    }

    // =========================================================================
    // 2. AI API ì—°ë™ (ë¬¸ì œ ìƒì„± ë¡œì§)
    // =========================================================================

    /**
     * @description AI APIë¥¼ í˜¸ì¶œí•˜ì—¬ ìƒˆë¡œìš´ í€´ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (4ì§€ì„ ë‹¤í˜•)
     * @param {number} count - ìƒì„±í•  ë¬¸ì œ ìˆ˜ (8 ë˜ëŠ” 4)
     * @returns {Promise<Array<Object>>} ìƒì„±ëœ í€´ì¦ˆ ë°°ì—´
     */
    async function generateNewQuestions(count) {
        const apiKey = getApiKey();
        if (!apiKey) {
            window.showNotification('ğŸ”‘ Gemini API í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë©”ì¸ ë©”ë‰´ì—ì„œ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error', true);
            return [];
        }

        window.showNotification(`ìƒˆë¡œìš´ í€´ì¦ˆ ${count}ê°œ ìƒì„± ì¤‘...`, 'loading');
        
        const topicsNeeded = Math.ceil(count / 2); 
        const questionsPerTopic = count / topicsNeeded;

        const shuffledTopics = [...QUIZ_TOPICS].sort(() => 0.5 - Math.random());
        const selectedTopics = shuffledTopics.slice(0, topicsNeeded);

        const systemPrompt = `Act as a strict quiz master. Generate exactly ${count} unique, challenging general knowledge questions in Korean, divided equally among ${topicsNeeded} topics: [${selectedTopics.join(', ')}]. You must generate exactly ${questionsPerTopic} questions per topic. For each question, provide the correct answer, three plausible incorrect distractors, and a detailed explanation in Korean covering why the answer is correct and briefly explaining why the incorrect options are wrong.`;
        
        const userQuery = `ìƒˆë¡œìš´ 4ì§€ì„ ë‹¤í˜• í€´ì¦ˆ ${count}ê°œë¥¼ ${selectedTopics.join(', ')} ì£¼ì œë¡œ ìƒì„±í•´ ì£¼ì„¸ìš”. ê° ë¬¸ì œì—ëŠ” ê³ ìœ  ID, ì£¼ì œ, ì§ˆë¬¸, ì •ë‹µ, ê·¸ë¦¬ê³  ì •ë‹µì„ í¬í•¨í•œ 4ê°œì˜ ë³´ê¸°(options) ë°°ì—´, ê·¸ë¦¬ê³  ì •ë‹µê³¼ ì˜¤ë‹µì— ëŒ€í•œ ëª…í™•í•œ í•´ì„¤ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.`;
        
        // API URLì— ë™ì ìœ¼ë¡œ í‚¤ ì£¼ì…
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "id": { "type": "STRING", "description": "ê³ ìœ  ì‹ë³„ì (UUID)" },
                    "topic": { "type": "STRING", "description": "10ê°€ì§€ ì£¼ì œ ì¤‘ í•˜ë‚˜" },
                    "question": { "type": "STRING", "description": "ì§ˆë¬¸ ë‚´ìš©" },
                    "answer": { "type": "STRING", "description": "ì •í™•í•œ ì •ë‹µ (ë³´ê¸° ì¤‘ í•˜ë‚˜)" },
                    "options": { 
                        "type": "ARRAY", 
                        "items": { "type": "STRING" },
                        "description": "ì •ë‹µì„ í¬í•¨í•œ 4ê°œì˜ ë³´ê¸°"
                    },
                    "explanation": { "type": "STRING", "description": "ì •ë‹µê³¼ ì˜¤ë‹µì„ í¬í•¨í•˜ëŠ” ìƒì„¸ í•´ì„¤" }
                },
                "required": ["id", "topic", "question", "answer", "options", "explanation"],
                "propertyOrdering": ["id", "topic", "question", "answer", "options", "explanation"]
            }
        };

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: responseSchema
            }
        };

        const maxRetries = 3;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`API response error (Status: ${response.status}):`, errorBody);
                    
                    let errorMessage = `API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP ${response.status}).`;
                    
                    try {
                        const errorJson = JSON.parse(errorBody);
                        if (errorJson.error && errorJson.error.message) {
                            errorMessage += `\nì„œë²„ ì‘ë‹µ: ${errorJson.error.message.substring(0, 100)}...`;
                        } else {
                            errorMessage += `\nì„œë²„ ë³¸ë¬¸: ${errorBody.substring(0, 100)}...`;
                        }
                    } catch (e) {
                         errorMessage += `\nì„œë²„ ë³¸ë¬¸: ${errorBody.substring(0, 100)}...`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) throw new Error("API did not return structured content.");

                let newQuizzes = JSON.parse(jsonText);
                
                newQuizzes = newQuizzes.filter(q => 
                    q.question && q.answer && Array.isArray(q.options) && q.options.length === 4
                    && q.explanation
                ).map(q => ({
                    ...q,
                    id: q.id || generateUUID(),
                    topic: q.topic || 'ì¼ë°˜ ìƒì‹',
                    question: q.question,
                    answer: q.answer,
                    options: q.options,
                    explanation: q.explanation
                }));
                
                if (newQuizzes.length !== count) {
                    throw new Error(`Generated quiz count is ${newQuizzes.length}, expected ${count}.`);
                }
                
                window.hideNotification();
                return newQuizzes;
            } catch (error) {
                console.error(`Attempt ${i + 1} failed:`, error);
                
                if (i === maxRetries - 1) {
                    window.showNotification(`í€´ì¦ˆ ìƒì„±ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ${error.message}`, 'error', true);
                    return [];
                }
                
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); 
            }
        }
        
        return [];
    }

    /** @description ë¡œì»¬ ë°ì´í„°ì™€ í˜„ì¬ ë‚ ì§œë¥¼ í™•ì¸í•˜ì—¬ ìƒˆë¡œìš´ í€´ì¦ˆë¥¼ ìƒì„±í• ì§€ ê²°ì •í•©ë‹ˆë‹¤. */
    window.checkAndInitializeQuiz = async () => {
        accumulatedQuizzes = loadQuizData();
        quizHistory = loadQuizHistory();
        
        // **ìˆ˜ì •ëœ ë¶€ë¶„:** Firebase ì‹¤íŒ¨ ì‹œ ë°œìƒí•˜ëŠ” ì¤‘ë³µ ì•Œë¦¼ì„ ì œê±°í•©ë‹ˆë‹¤. 
        // Firebase ê´€ë ¨ ê²½ê³ ëŠ” initializeFirebase() í•¨ìˆ˜ ë‚´ì—ì„œ ì½˜ì†” ë¡œê·¸ë¡œ ì¶©ë¶„íˆ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        
        renderMainMenu();
    };

    // =========================================================================
    // 3. íƒ€ì´ë¨¸ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    // =========================================================================

    /** @description 15ì´ˆ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. */
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);

        let timeLeft = TIME_LIMIT;
        const timerElement = document.getElementById('quiz-timer');
        if (timerElement) {
            timerElement.textContent = timeLeft;
            timerElement.style.color = '#4ade80'; // Green

            timerInterval = setInterval(() => {
                timeLeft--;
                if (timerElement) {
                    timerElement.textContent = timeLeft;
                    
                    if (timeLeft <= 5) {
                        timerElement.style.color = '#ef4444'; // Red-400
                        timerElement.classList.add('animate-pulse');
                    } else if (timeLeft <= 10) {
                        timerElement.style.color = '#facc15'; // Yellow-400
                    }
                    
                    timerElement.classList.remove('timer-animate'); 
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            timerElement.classList.add('timer-animate');
                        });
                    });

                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timeUp();
                }
            }, 1000);
        }
    }
    
    /** @description ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆì„ ë•Œ ì²˜ë¦¬í•©ë‹ˆë‹¤. */
    function timeUp() {
        if (contentDiv.querySelector('#answer-reveal:not(.hidden)')) return; 
        
        const timerElement = document.getElementById('quiz-timer');
        if(timerElement) timerElement.classList.remove('animate-pulse', 'timer-animate');

        window.showNotification('â³ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤!', 'info', true);
        
        simulateTimeOverAnswer();
    }
    
    /** @description ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆì„ ë•Œ ì˜¤ë‹µ ì²˜ë¦¬ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤. */
    function simulateTimeOverAnswer() {
        const q = currentQuizSet[currentQuestionIndex];
        const resultMessage = document.getElementById('result-message');
        const answerReveal = document.getElementById('answer-reveal');
        const answerDisplay = document.getElementById('correct-answer-display');
        const explanationDisplay = document.getElementById('explanation-display'); 

        contentDiv.querySelectorAll('.quiz-option-button').forEach(btn => {
            btn.disabled = true;
            btn.classList.remove('hover:bg-purple-600');
            
            const btnOption = btn.getAttribute('data-option');
            const normalizedCorrectAnswer = q.answer.toLowerCase().replace(/\s/g, '');
            const normalizedBtnOption = btnOption.toLowerCase().replace(/\s/g, '');
            
            if (normalizedBtnOption === normalizedCorrectAnswer) {
                 btn.classList.add('bg-green-800', 'border-green-500'); 
            }
        });

        answerDisplay.textContent = q.answer;
        explanationDisplay.textContent = q.explanation;
        answerReveal.classList.remove('hidden');

        resultMessage.innerHTML = '<span class="text-red-400">âŒ ì‹œê°„ ì´ˆê³¼! (ì˜¤ë‹µ ì²˜ë¦¬)</span>';
        
        quizHistory.push({
            quizId: q.id,
            topic: q.topic,
            isCorrect: false,
            answeredAt: new Date().toISOString()
        });
        saveQuizHistory(quizHistory);
    }
    
    // =========================================================================
    // 4. UI ë Œë”ë§ ë° ëª¨ë“œë³„ ë¡œì§ (í‚¤ ì…ë ¥ UI ìœ ì§€)
    // =========================================================================

    /** @description ë©”ì¸ ë©”ë‰´ í™”ë©´ì„ ë Œë”ë§í•©ë‹ˆë‹¤. (API í‚¤ ì…ë ¥ í•„ë“œ ì¶”ê°€) */
    function renderMainMenu() {
        if (timerInterval) clearInterval(timerInterval);

        quizMode = 'menu';
        const incorrectCount = quizHistory.filter(h => !h.isCorrect).length;
        const currentApiKey = getApiKey();
        const isKeyPresent = currentApiKey.length > 0;
        
        // í‚¤ ìƒíƒœì— ë”°ë¥¸ ì„¤ëª… ë° ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        const keyStatusHtml = isKeyPresent 
            ? `<span class="text-green-400">âœ… API í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</span>`
            : `<span class="text-red-400">âŒ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤! ì•„ë˜ì— ì…ë ¥í•´ì£¼ì„¸ìš”.</span>`;
            
        const quizButtonDisabled = !isKeyPresent;

        contentDiv.innerHTML = `
            <div class="w-full text-center p-6">
                <p class="text-xl mb-4 text-gray-300">
                    í˜„ì¬ ëˆ„ì ëœ ì´ í€´ì¦ˆ ìˆ˜: <span class="text-purple-400 font-bold">${accumulatedQuizzes.length}</span>ê°œ
                </p>

                <!-- API Key Input Section (ì¶”ê°€ë¨) -->
                <div class="bg-gray-800 p-4 rounded-xl mb-8 w-full shadow-inner text-left">
                    <p class="text-lg font-semibold mb-2">${keyStatusHtml}</p>
                    <input type="password" id="api-key-input" 
                           placeholder="ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í•„ìˆ˜)" 
                           value="${currentApiKey}"
                           oninput="document.getElementById('save-key-btn').disabled = this.value.trim().length === 0"
                           class="w-full p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500 border-none">
                    <button id="save-key-btn" 
                            class="gradient-button w-full mt-3 py-2 rounded-lg text-sm"
                            onclick="window.saveApiKey(document.getElementById('api-key-input').value)"
                            ${currentApiKey.length === 0 ? 'disabled' : ''}>
                        API í‚¤ ì €ì¥
                    </button>
                    ${isKeyPresent ? `<button class="w-full mt-2 py-2 rounded-lg text-sm bg-red-600 hover:bg-red-700" onclick="window.saveApiKey('')">í‚¤ ì œê±°</button>` : ''}
                </div>
                <!-- End API Key Input Section -->
                
                <div class="flex flex-col space-y-6">
                    <button id="start-quiz-btn" class="gradient-button w-full py-4 px-8 rounded-xl text-lg shadow-lg" 
                            onclick="startQuiz()" ${quizButtonDisabled ? 'disabled' : ''}>
                        ğŸš€ í€´ì¦ˆ ì„¸íŠ¸ ë„ì „ (8ë¬¸ì œ ëœë¤ í’€ì´)
                    </button>
                    <button id="review-mode-btn" class="gradient-button w-full py-4 px-8 rounded-xl text-lg shadow-lg" 
                            onclick="startReviewMode()" ${incorrectCount === 0 ? 'disabled' : ''}>
                        ğŸ“š ë³µìŠµ ëª¨ë“œ (${incorrectCount}ê°œ í‹€ë¦° ë¬¸ì œ)
                    </button>
                    <p class="text-sm mt-8 text-gray-400">
                        * í€´ì¦ˆ ë„ì „ì„ ìœ„í•´ì„œëŠ” **API í‚¤ ì…ë ¥ì´ í•„ìˆ˜**ì…ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        `;
    }

    // --- í€´ì¦ˆ ëª¨ë“œ ë¡œì§ (API í‚¤ë¥¼ getApiKey()ë¡œ ëŒ€ì²´) ---

    /** @description í€´ì¦ˆ ëª¨ë“œë¥¼ ì‹œì‘í•˜ê³ , í•„ìš” ì‹œ ë¬¸ì œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. */
    async function startQuiz() {
        quizMode = 'quiz';
        currentQuestionIndex = 0;
        
        // API í‚¤ê°€ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨
        if (!getApiKey()) {
            renderMainMenu();
            return;
        }

        const lastDate = localStorage.getItem(LOCAL_STORAGE_DATE_KEY);
        const today = new Date().toDateString();

        let generateCount = 0;
        let isFirstAccessToday = lastDate !== today;

        if (isFirstAccessToday) {
            generateCount = 8;
        } else if (accumulatedQuizzes.length === 0) {
            generateCount = 8;
        } else {
            generateCount = 4;
        }

        if (generateCount > 0) {
            const newQuizzes = await generateNewQuestions(generateCount);
            
            if (newQuizzes.length === generateCount) {
                accumulatedQuizzes = [...accumulatedQuizzes, ...newQuizzes];
                saveQuizData(accumulatedQuizzes);
                
                if (isFirstAccessToday) {
                    localStorage.setItem(LOCAL_STORAGE_DATE_KEY, today);
                    window.showNotification(`ğŸ‰ ì˜¤ëŠ˜ì˜ ìƒˆë¡œìš´ í€´ì¦ˆ ${generateCount}ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ ${accumulatedQuizzes.length}ê°œì˜ í€´ì¦ˆê°€ ëˆ„ì ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info', true);
                } else {
                    window.showNotification(`ğŸ‰ ì¶”ê°€ í€´ì¦ˆ ${generateCount}ê°œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ ${accumulatedQuizzes.length}ê°œì˜ í€´ì¦ˆê°€ ëˆ„ì ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info', true);
                }
            } else if (accumulatedQuizzes.length === 0) {
                // API í˜¸ì¶œ ì‹¤íŒ¨ AND ê¸°ì¡´ í€´ì¦ˆ ì—†ìŒ
                renderMainMenu();
                return;
            } else {
                // API í˜¸ì¶œ ì‹¤íŒ¨í–ˆì§€ë§Œ ê¸°ì¡´ í€´ì¦ˆ ìˆìŒ
                window.showNotification('ìƒˆ í€´ì¦ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ í€´ì¦ˆë¡œ í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'info', true);
            }
        } else if (accumulatedQuizzes.length === 0) {
             window.showNotification('í’€ ìˆ˜ ìˆëŠ” í€´ì¦ˆê°€ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.', 'error', true);
             renderMainMenu();
             return;
        }

        currentQuizSet = [...accumulatedQuizzes]
            .sort(() => 0.5 - Math.random()) 
            .filter(q => q.options && q.options.length === 4) 
            .slice(0, 8); 
        
        if (currentQuizSet.length === 0) {
            window.showNotification('í’€ ìˆ˜ ìˆëŠ” í€´ì¦ˆê°€ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.', 'error', true);
            renderMainMenu();
            return;
        }
        
        renderQuestion();
    }

    /** @description í˜„ì¬ ë¬¸ì œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. (ê¸°ì¡´ ìœ ì§€) */
    function renderQuestion() {
        if (timerInterval) clearInterval(timerInterval);

        if (currentQuestionIndex >= currentQuizSet.length) {
            endQuiz();
            return;
        }

        const q = currentQuizSet[currentQuestionIndex];
        
        let shuffledOptions = [...(q.options || [q.answer])];
        if (shuffledOptions.length === 4) {
            shuffledOptions = shuffleArray(shuffledOptions);
        } else {
            shuffledOptions = [q.answer];
        }


        const optionsHtml = shuffledOptions.map((option, index) => `
            <button class="quiz-option-button w-full py-3 px-4 rounded-xl text-lg text-left mb-3 shadow-md" 
                    data-option="${option}" onclick="selectAnswer('${option}')">
                ${['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][index]} ${option}
            </button>
        `).join('');


        contentDiv.innerHTML = `
            <div class="flex justify-between items-center w-full mb-4">
                <p class="text-base text-purple-300">
                    ${currentQuestionIndex + 1}/${currentQuizSet.length} | ì£¼ì œ: ${q.topic}
                </p>
                <div id="quiz-timer" class="text-4xl font-extrabold text-green-400 leading-none">
                    ${TIME_LIMIT}
                </div>
            </div>

            <div class="quiz-card mb-6 w-full shadow-2xl">
                <p class="text-2xl font-semibold text-white">
                    Q. ${q.question}
                </p>
            </div>
            
            <div id="options-container" class="w-full">
                ${optionsHtml}
            </div>

            <div id="result-message" class="mt-4 text-center font-bold text-xl min-h-[30px]"></div>
            
            <div id="answer-reveal" class="quiz-card mt-4 hidden text-center">
                <p class="text-sm text-gray-300">ì •ë‹µ</p>
                <p class="text-2xl font-extrabold text-green-400 mb-3" id="correct-answer-display"></p>
                
                <div class="text-left bg-gray-700 p-4 rounded-lg mt-4">
                    <p class="text-sm font-semibold text-purple-300 mb-2">í•´ì„¤</p>
                    <p class="text-base text-gray-200" id="explanation-display"></p>
                </div>
                
                <button id="main-action-button" class="gradient-button mt-4 py-2 px-6 rounded-full text-sm" onclick="nextQuestion()">
                    ë‹¤ìŒ ë¬¸ì œ
                </button>
            </div>
        `;
        
        startTimer();
    }

    /** @description í€´ì¦ˆ ì •ë‹µì„ í™•ì¸í•˜ê³  ê²°ê³¼ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤. (ê¸°ì¡´ ìœ ì§€) */
    window.selectAnswer = (selectedOption) => {
        if (timerInterval) clearInterval(timerInterval);
        
        if (contentDiv.querySelector('#answer-reveal:not(.hidden)')) return; 

        const timerElement = document.getElementById('quiz-timer');
        if(timerElement) timerElement.classList.remove('animate-pulse', 'timer-animate');
        
        const q = currentQuizSet[currentQuestionIndex];
        const normalizedSelected = selectedOption.toLowerCase().replace(/\s/g, '');
        const normalizedCorrectAnswer = q.answer.toLowerCase().replace(/\s/g, '');

        const isCorrect = normalizedSelected === normalizedCorrectAnswer;
        
        const resultMessage = document.getElementById('result-message');
        const answerReveal = document.getElementById('answer-reveal');
        const answerDisplay = document.getElementById('correct-answer-display');
        const explanationDisplay = document.getElementById('explanation-display'); 

        contentDiv.querySelectorAll('.quiz-option-button').forEach(btn => {
            btn.disabled = true;
            const btnOption = btn.getAttribute('data-option');
            const normalizedBtnOption = btnOption.toLowerCase().replace(/\s/g, '');
            
            if (normalizedBtnOption === normalizedSelected) {
                 btn.classList.add(isCorrect ? 'bg-green-600' : 'bg-red-600');
                 btn.classList.remove('bg-gray-700', 'hover:bg-purple-600');
            } else if (normalizedBtnOption === normalizedCorrectAnswer) {
                 btn.classList.add('bg-green-800', 'border-green-500'); 
                 btn.classList.remove('bg-gray-700', 'hover:bg-purple-600');
            } else {
                 btn.classList.remove('hover:bg-purple-600');
            }
        });


        answerDisplay.textContent = q.answer;
        explanationDisplay.textContent = q.explanation;
        answerReveal.classList.remove('hidden');

        if (isCorrect) {
            resultMessage.innerHTML = '<span class="text-green-400">âœ… ì •ë‹µì…ë‹ˆë‹¤!</span>';
        } else {
            resultMessage.innerHTML = '<span class="text-red-400">âŒ ì˜¤ë‹µì…ë‹ˆë‹¤.</span>';
        }

        quizHistory.push({
            quizId: q.id,
            topic: q.topic,
            isCorrect: isCorrect,
            answeredAt: new Date().toISOString()
        });
        saveQuizHistory(quizHistory);
    };

    /** @description ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤. (ê¸°ì¡´ ìœ ì§€) */
    window.nextQuestion = () => {
        if (timerInterval) clearInterval(timerInterval);
        currentQuestionIndex++;
        renderQuestion();
    };

    /** @description í€´ì¦ˆë¥¼ ì¢…ë£Œí•˜ê³  ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. (ê¸°ì¡´ ìœ ì§€) */
    function endQuiz() {
        if (timerInterval) clearInterval(timerInterval);

        const total = currentQuizSet.length;
        const recentHistory = quizHistory.slice(-total); 
        const correctCount = recentHistory.filter(h => h.isCorrect).length;
        const score = Math.round((correctCount / total) * 100);

        contentDiv.innerHTML = `
            <div class="quiz-card w-full text-center p-8 shadow-2xl">
                <p class="text-4xl font-extrabold mb-4 text-purple-400">í€´ì¦ˆ ì¢…ë£Œ!</p>
                <p class="text-2xl mb-8">
                    ì´ ${total}ë¬¸ì œ ì¤‘ <span class="text-green-400 font-bold">${correctCount}ê°œ</span> ì •ë‹µ!
                </p>
                <p class="text-6xl font-black mb-8">${score}ì </p>
                
                <button id="main-action-button" class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" onclick="renderMainMenu()">
                    ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        `;
    }


    // --- ë³µìŠµ ëª¨ë“œ ë¡œì§ (ê¸°ì¡´ ìœ ì§€) ---

    /** @description ë³µìŠµ ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. */
    function startReviewMode() {
        if (timerInterval) clearInterval(timerInterval);

        quizMode = 'review';
        currentQuestionIndex = 0;
        
        const incorrectHistory = quizHistory.filter(h => !h.isCorrect);

        currentQuizSet = incorrectHistory.map(h => {
            const quiz = accumulatedQuizzes.find(q => q.id === h.quizId);
            return quiz ? { ...quiz, historyId: h.quizId } : null;
        }).filter(q => q && q.options && q.options.length === 4);

        const incorrectCount = currentQuizSet.length;

        if (incorrectCount === 0) {
            window.showNotification('ğŸ‰ í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ì™„ë²½í•´ìš”.', 'info', true);
            renderMainMenu();
            return;
        }

        window.showNotification(`ğŸ“š ë³µìŠµ ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì´ ${incorrectCount}ê°œì˜ í‹€ë¦° ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.`, 'info');
        renderReviewQuestion();
    }

    /** @description ë³µìŠµ ë¬¸ì œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤. */
    function renderReviewQuestion() {
        if (timerInterval) clearInterval(timerInterval);

        if (currentQuestionIndex >= currentQuizSet.length) {
            endReview();
            return;
        }

        const q = currentQuizSet[currentQuestionIndex];
        
        let shuffledOptions = [...(q.options || [q.answer])];
        if (shuffledOptions.length === 4) {
             shuffledOptions = shuffleArray(shuffledOptions);
        } else {
            shuffledOptions = [q.answer];
        }

        const optionsHtml = shuffledOptions.map((option, index) => {
            const isCorrectOption = option.toLowerCase().replace(/\s/g, '') === q.answer.toLowerCase().replace(/\s/g, '');
            const style = isCorrectOption ? 'bg-green-800 text-white font-bold border-green-500' : 'bg-gray-700 text-gray-300 border-transparent';
            
            return `
                <button class="w-full py-3 px-4 rounded-xl text-lg text-left mb-3 shadow-md border ${style}" disabled>
                    ${['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][index]} ${option} ${isCorrectOption ? ' âœ… ì •ë‹µ' : ''}
                </button>
            `;
        }).join('');

        contentDiv.innerHTML = `
            <div class="quiz-card w-full mb-6 shadow-2xl">
                <p class="text-sm text-purple-300 mb-2">
                    ë³µìŠµ ë¬¸ì œ ${currentQuestionIndex + 1}/${currentQuizSet.length} | ì£¼ì œ: ${q.topic}
                </p>
                <p class="text-2xl font-semibold mb-6 text-white">
                    Q. ${q.question}
                </p>
            </div>
            
            <div id="options-container" class="w-full mb-4">
                ${optionsHtml}
            </div>
            
            <div class="text-left quiz-card p-4 rounded-lg mt-4 w-full">
                <p class="text-sm font-semibold text-purple-300 mb-2">ì •ë‹µ: <span class="text-green-400 font-bold">${q.answer}</span></p>
                <p class="text-sm font-semibold text-purple-300 mb-2 mt-4 border-t border-gray-600 pt-4">í•´ì„¤</p>
                <p class="text-base text-gray-200">${q.explanation || 'í•´ì„¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
            </div>

            <button id="main-action-button" class="gradient-button mt-6 w-full py-3 rounded-xl text-lg shadow-lg" onclick="nextReviewQuestion()">
                ë‹¤ìŒ ë³µìŠµ ë¬¸ì œ í™•ì¸
            </button>
            
            <button class="text-sm text-gray-400 mt-4 hover:text-red-400 transition-colors" onclick="removeReviewItem('${q.id}')">
                âœ… ì´ ë¬¸ì œ ì´ì œ ì•Œì•„ìš” (ì˜¤ë‹µ ëª©ë¡ì—ì„œ ì œê±°)
            </button>
        `;
    }

    /** @description ë‹¤ìŒ ë³µìŠµ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤. */
    window.nextReviewQuestion = () => {
        currentQuestionIndex++;
        renderReviewQuestion();
    };
    
    /** @description ë³µìŠµ ëª©ë¡ì—ì„œ í•´ë‹¹ ë¬¸ì œë¥¼ ì œê±°í•˜ê³  íˆìŠ¤í† ë¦¬ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. */
    window.removeReviewItem = (quizId) => {
        quizHistory = quizHistory.filter(h => !(h.quizId === quizId && !h.isCorrect));
        saveQuizHistory(quizHistory);
        
        startReviewMode();
    };

    /** @description ë³µìŠµ ëª¨ë“œë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. */
    function endReview() {
        if (timerInterval) clearInterval(timerInterval);

        contentDiv.innerHTML = `
            <div class="quiz-card w-full text-center p-8 shadow-2xl">
                <p class="text-4xl font-extrabold mb-4 text-green-400">ë³µìŠµ ì™„ë£Œ!</p>
                <p class="text-xl mb-8">
                    í‹€ë ¸ë˜ ëª¨ë“  ë¬¸ì œë¥¼ í™•ì¸í•˜ì…¨ìŠµë‹ˆë‹¤.
                </p>
                
                <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" onclick="renderMainMenu()">
                    ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        `;
    }
    
    // =========================================================================
    // 5. í‚¤ë³´ë“œ ì ‘ê·¼ì„± (ê¸°ì¡´ ìœ ì§€)
    // =========================================================================
    
    /** @description ì „ì—­ í‚¤ ì…ë ¥ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. */
    function handleGlobalKeydown(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); 

            const notificationArea = document.getElementById('notification-area');
            const okButton = document.getElementById('notification-ok-button');
            if (notificationArea && !notificationArea.classList.contains('hidden') && okButton && !okButton.classList.contains('hidden')) {
                okButton.click();
                return;
            }

            const mainActionButton = document.getElementById('main-action-button');
            if (mainActionButton && !mainActionButton.classList.contains('hidden') && !mainActionButton.disabled) {
                mainActionButton.click();
                return;
            }

            const startQuizButton = document.getElementById('start-quiz-btn');
            if (quizMode === 'menu' && startQuizButton && !startQuizButton.disabled) {
                startQuizButton.click();
                return;
            }
            
            const optionsContainer = document.getElementById('options-container');
            if (quizMode === 'quiz' && optionsContainer && !contentDiv.querySelector('#answer-reveal:not(.hidden)')) {
                const optionButtons = Array.from(optionsContainer.querySelectorAll('.quiz-option-button:not([disabled])'));
                
                if (optionButtons.length > 0) {
                    optionButtons[0].click();
                    return;
                }
            }
        }
    }

    document.addEventListener('keydown', handleGlobalKeydown);

</script>

</body>
</html>