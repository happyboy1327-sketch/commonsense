<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>랜덤 상식 퀴즈</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Tailwind default) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght=100..900&display=swap" rel="stylesheet">
    <style>
        /* 커스텀 스타일 및 폰트 설정 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e1e2d; /* 짙은 배경 */
            color: #e0e0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* 블러 효과를 위한 배경 컨테이너 */
        #app-container {
            background: rgba(30, 30, 50, 0.7); /* 불투명한 배경 */
            backdrop-filter: blur(10px); /* 블러 효과 */
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 95%;
            padding: 0;
            overflow: hidden; /* 내부 요소가 넘치지 않도록 */
        }
        
        /* 메인 버튼 스타일 */
        .gradient-button {
            background: linear-gradient(135deg, #4f46e5 0%, #a855f7 100%); /* 보라색 계열 그라데이션 */
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(168, 85, 247, 0.5);
        }

        .gradient-button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* 퀴즈 옵션 버튼 스타일 */
        .option-button {
            background-color: #3e3e5d; /* 옵션 배경 */
            border: 2px solid #5a5a7a;
            transition: background-color 0.1s, border-color 0.1s;
        }

        .option-button:hover:not(:disabled) {
            background-color: #4a4a6e;
            border-color: #8b5cf6; /* hover 시 보라색 테두리 */
        }

        /* 정답/오답 스타일 */
        .correct {
            background-color: #10b981 !important; /* 에메랄드 그린 */
            border-color: #059669 !important;
            color: white !important;
        }

        .incorrect {
            background-color: #ef4444 !important; /* 빨간색 */
            border-color: #dc2626 !important;
            color: white !important;
        }

        .faded-out {
            opacity: 0.5;
            pointer-events: none;
        }

        .quiz-card {
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <div id="app-container" class="p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-white">랜덤 상식 퀴즈</h1>
        </header>
        <div id="content" class="w-full">
            <!-- Content will be rendered here by JavaScript -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore 디버그 로깅 활성화
        setLogLevel('Debug');

        // =========================================================================
        // 1. Firebase 및 전역 상태 설정
        // =========================================================================

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'loading'; // 초기 상태

        // 전역 UI 요소
        const contentDiv = document.getElementById('content');

        // 퀴즈 관련 상태
        let quizzes = [];             // 현재 난이도의 모든 퀴즈
        let currentQuizSet = [];      // 실제로 풀 퀴즈 목록 (랜덤 추출된 10개)
        let currentQuizIndex = 0;     // 현재 풀고 있는 퀴즈의 인덱스
        let quizHistory = [];         // 사용자가 푼 모든 퀴즈 기록 (Firestore 동기화)
        let timerInterval = null;     // 퀴즈 타이머
        let timeRemaining = 15;       // 문제당 시간 (초)
        let selectedDifficulty = 'Easy'; // 현재 선택된 난이도

        // =========================================================================
        // 2. 데이터 구조 및 모의 데이터
        // =========================================================================

        /** @typedef {Object} Quiz
         * @property {string} id
         * @property {string} question
         * @property {string[]} options
         * @property {number} answerIndex
         * @property {'Easy'|'Normal'|'Hard'} difficulty
         */

        /** @type {Quiz[]} */
        const mockQuizzes = [
            // Easy
            { id: 'e1', question: '지구상에서 가장 큰 포유류는 무엇일까요?', options: ['코끼리', '기린', '흰수염고래', '하마'], answerIndex: 2, difficulty: 'Easy' },
            { id: 'e2', question: '대한민국의 수도는 어디일까요?', options: ['부산', '서울', '제주', '평양'], answerIndex: 1, difficulty: 'Easy' },
            { id: 'e3', question: '물의 화학 기호는 무엇일까요?', options: ['O2', 'CO2', 'H2O', 'NaCl'], answerIndex: 2, difficulty: 'Easy' },
            { id: 'e4', question: '태양계의 중심에 있는 항성은 무엇일까요?', options: ['지구', '달', '화성', '태양'], answerIndex: 3, difficulty: 'Easy' },
            { id: 'e5', question: '사계절 중 가장 추운 계절은 무엇일까요?', options: ['봄', '여름', '가을', '겨울'], answerIndex: 3, difficulty: 'Easy' },
            // Normal
            { id: 'n1', question: '르네상스 시대의 대표적인 화가로 "모나리자"를 그린 사람은 누구일까요?', options: ['빈센트 반 고흐', '레오나르도 다빈치', '파블로 피카소', '클로드 모네'], answerIndex: 1, difficulty: 'Normal' },
            { id: 'n2', question: '중국의 만리장성은 무엇을 막기 위해 건설되었을까요?', options: ['자연재해', '이민자 유입', '북방 민족의 침입', '무역선 출입'], answerIndex: 2, difficulty: 'Normal' },
            { id: 'n3', question: '노벨상을 수여하는 나라는 어디일까요?', options: ['미국', '영국', '스웨덴', '프랑스'], answerIndex: 2, difficulty: 'Normal' },
            { id: 'n4', question: '인체의 뼈 중 가장 긴 뼈는 무엇일까요?', options: ['쇄골', '경골', '대퇴골', '척추'], answerIndex: 2, difficulty: 'Normal' },
            { id: 'n5', question: '셰익스피어의 4대 비극에 해당하지 않는 작품은 무엇일까요?', options: ['햄릿', '리어왕', '로미오와 줄리엣', '맥베스'], answerIndex: 2, difficulty: 'Normal' },
            // Hard
            { id: 'h1', question: '양자역학에서 불확정성 원리를 제안한 과학자는 누구일까요?', options: ['아인슈타인', '보어', '하이젠베르크', '슈뢰딩거'], answerIndex: 2, difficulty: 'Hard' },
            { id: 'h2', question: '고대 로마의 율리우스 카이사르가 남긴 유명한 말 "왔노라, 보았노라, 이겼노라"의 라틴어 원문은 무엇일까요?', options: ['Carpe Diem', 'Veni, Vidi, Vici', 'Alea iacta est', 'Et tu, Brute?'], answerIndex: 1, difficulty: 'Hard' },
            { id: 'h3', question: '경제학에서 "보이지 않는 손" 개념을 제시한 학자는 누구일까요?', options: ['존 메이너드 케인스', '칼 마르크스', '애덤 스미스', '밀턴 프리드먼'], answerIndex: 2, difficulty: 'Hard' },
            { id: 'h4', question: '1905년 아인슈타인이 발표한 4편의 논문은 기적의 해 논문(Annus Mirabilis Papers)이라 불립니다. 이 논문들에 포함되지 않는 주제는 무엇일까요?', options: ['광전 효과', '브라운 운동', '특수 상대성 이론', '양자장 이론'], answerIndex: 3, difficulty: 'Hard' },
            { id: 'h5', question: '프랑스 혁명의 구호인 "자유, 평등, 박애" 중 "박애"에 해당하는 프랑스어 단어는 무엇일까요?', options: ['Liberté', 'Égalité', 'Fraternité', 'Justice'], answerIndex: 2, difficulty: 'Hard' },
        ];


        // =========================================================================
        // 3. Firebase Firestore 및 인증 (Auth)
        // =========================================================================

        /** @description LocalStorage에 퀴즈 히스토리를 저장합니다. (비인가/익명 사용자용) */
        function saveQuizHistory(history) {
            localStorage.setItem(`quizHistory_${userId}`, JSON.stringify(history));
            console.log("Quiz History saved to LocalStorage:", history.length);
        }
        
        /** @description Firebase 인증 및 Firestore를 초기화하고 사용자 ID를 가져옵니다. */
        async function initializeFirebase() {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } else {
                console.error("Firebase config is missing.");
                // 비인가 모드에서도 실행되도록 더미 객체 할당
                auth = { currentUser: { uid: 'anonymous-' + Math.random().toString(36).substring(2, 9) } };
                userId = auth.currentUser.uid;
                startListeningToHistory();
                renderMainMenu();
                return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth error:", error);
                // 인증 실패 시 익명 사용자 ID를 대체 사용
                auth.currentUser = { uid: 'error-' + Math.random().toString(36).substring(2, 9) };
            }
            
            // 인증 상태 변화 리스너
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // onAuthStateChanged가 발생했으나 user가 null인 경우 익명 ID 부여
                    userId = auth.currentUser?.uid || 'anon-' + Math.random().toString(36).substring(2, 9);
                }
                console.log("User ID set:", userId);
                startListeningToHistory(); // 인증이 완료되면 히스토리 리스너 시작
                renderMainMenu(); // 메인 메뉴 렌더링
            });
        }
        
        /** @description Firestore에서 퀴즈 히스토리 변경 사항을 실시간으로 수신하거나 LocalStorage에서 로드합니다. */
        function startListeningToHistory() {
            if (!db || userId === 'loading' || userId.startsWith('error-') || userId.startsWith('anon-') || userId.startsWith('anonymous-')) {
                 // 파이어베이스가 없거나, 익명 또는 에러 유저인 경우 LocalStorage에서 로드
                console.warn("Firestore history listening skipped. Loading from LocalStorage.");
                quizHistory = JSON.parse(localStorage.getItem(`quizHistory_${userId}`)) || [];
                // 로드 후 즉시 정렬 (가장 최근 항목이 앞으로 오도록)
                quizHistory.sort((a, b) => b.timestamp - a.timestamp);
                return; 
            }

            const historyCollectionPath = `/artifacts/${appId}/users/${userId}/quizHistory`;
            const q = query(collection(db, historyCollectionPath));

            onSnapshot(q, (snapshot) => {
                const history = [];
                snapshot.forEach((doc) => {
                    history.push(doc.data());
                });
                // 가장 최근의 50개 항목만 유지 (성능을 위해)
                history.sort((a, b) => b.timestamp - a.timestamp);
                quizHistory = history.slice(0, 50); 
                // 메인 메뉴에 변경 사항 반영
                if (document.getElementById('content-title')?.innerText === '메인 메뉴') {
                    renderMainMenu();
                }
                console.log("Quiz History updated from Firestore:", quizHistory.length);
            }, (error) => {
                console.error("Error listening to history:", error);
            });
        }
        
        /** @description 퀴즈 결과를 Firestore 또는 LocalStorage에 저장합니다. */
        async function saveQuizResult(quizId, isCorrect, difficulty) {
            const newEntry = {
                quizId,
                isCorrect,
                difficulty,
                timestamp: Date.now()
            };
            
            if (db && userId && !userId.startsWith('error-') && !userId.startsWith('anon-') && !userId.startsWith('anonymous-')) {
                // Firestore에 저장
                const historyCollectionPath = `/artifacts/${appId}/users/${userId}/quizHistory`;
                try {
                    // ID는 'difficulty_timestamp' 형태로 저장하여 고유성 확보
                    const docId = `${difficulty}_${Date.now()}_${Math.random().toString(36).substring(2, 6)}`;
                    await setDoc(doc(db, historyCollectionPath, docId), newEntry);
                } catch (error) {
                    console.error("Error saving to Firestore:", error);
                }
            } else {
                // LocalStorage에 저장 (익명 또는 에러 사용자)
                quizHistory.unshift(newEntry); // 최신 항목을 앞에 추가
                quizHistory = quizHistory.slice(0, 50); // 최대 50개 항목 유지
                saveQuizHistory(quizHistory); // **수정: LocalStorage에 명시적으로 저장**
            }
        }


        // =========================================================================
        // 4. UI 렌더링 및 로직
        // =========================================================================

        /** @description 메인 메뉴를 렌더링합니다. */
        window.renderMainMenu = () => {
            if (timerInterval) clearInterval(timerInterval);
            currentQuizSet = [];
            currentQuizIndex = 0;

            const reviewItems = quizHistory.filter(h => !h.isCorrect).length;
            const totalPlayed = quizHistory.length;
            const correctCount = quizHistory.filter(h => h.isCorrect).length;
            const accuracy = totalPlayed > 0 ? ((correctCount / totalPlayed) * 100).toFixed(1) : 0;

            contentDiv.innerHTML = `
                <div id="content-title" class="text-2xl font-semibold mb-6 text-center text-white">메인 메뉴</div>
                
                <!-- 현재 상태 카드 -->
                <div class="bg-[#2e2e4d] p-6 rounded-xl shadow-lg mb-6">
                    <p class="text-xl font-bold mb-3 text-white">내 퀴즈 기록</p>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <p class="text-sm text-gray-400">총 푼 문제</p>
                            <p class="text-2xl font-extrabold text-indigo-400">${totalPlayed}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">정답률</p>
                            <p class="text-2xl font-extrabold text-green-400">${accuracy}%</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">복습 필요</p>
                            <p class="text-2xl font-extrabold text-red-400">${reviewItems}</p>
                        </div>
                    </div>
                </div>

                <!-- 난이도 선택 -->
                <p class="text-xl font-bold mb-4 text-white">새 퀴즈 시작 (10문제)</p>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    ${['Easy', 'Normal', 'Hard'].map(diff => `
                        <button 
                            class="gradient-button py-3 rounded-xl text-lg shadow-md hover:shadow-xl" 
                            onclick="startNewQuiz('${diff}')">
                            ${diff}
                        </button>
                    `).join('')}
                </div>

                <!-- 복습 모드 버튼 -->
                ${reviewItems > 0 ? `
                    <p class="text-xl font-bold mb-4 text-white">오답 복습</p>
                    <button 
                        class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" 
                        onclick="startReviewMode()">
                        틀린 문제 복습하기 (${reviewItems}개)
                    </button>
                ` : `
                    <div class="text-center p-4 text-gray-400 bg-[#2e2e4d] rounded-xl">
                        <p>틀린 문제가 없습니다. 완벽해요!</p>
                    </div>
                `}
            `;
        };
        
        /** @description 퀴즈를 시작합니다. */
        window.startNewQuiz = (difficulty) => {
            selectedDifficulty = difficulty;
            quizzes = mockQuizzes.filter(q => q.difficulty === difficulty);
            
            // 10문제 랜덤 추출
            const shuffled = quizzes.sort(() => 0.5 - Math.random());
            currentQuizSet = shuffled.slice(0, 10);
            currentQuizIndex = 0;
            
            // 퀴즈 시작
            if (currentQuizSet.length > 0) {
                renderQuizQuestion();
            } else {
                contentDiv.innerHTML = `<p class="text-center text-red-400">해당 난이도의 퀴즈가 부족합니다.</p>`;
            }
        };

        /** @description 현재 퀴즈 문제를 렌더링하고 타이머를 시작합니다. */
        function renderQuizQuestion() {
            if (currentQuizIndex >= currentQuizSet.length) {
                endQuiz();
                return;
            }

            const currentQuiz = currentQuizSet[currentQuizIndex];
            timeRemaining = 15; // 타이머 초기화

            // 타이머 정리 후 재시작
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                document.getElementById('quiz-timer').innerText = timeRemaining.toString().padStart(2, '0');
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(null, currentQuiz.answerIndex); // 시간 초과 처리
                }
            }, 1000);

            contentDiv.innerHTML = `
                <div class="quiz-card w-full p-6 shadow-2xl">
                    <!-- 헤더 -->
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-[#3e3e5d]">
                        <h2 class="text-xl font-semibold text-indigo-400">
                            랜덤 상식 퀴즈 (난이도: ${selectedDifficulty})
                        </h2>
                        <div class="flex space-x-4">
                            <span class="text-lg font-bold text-gray-300">${currentQuizIndex + 1} / ${currentQuizSet.length}</span>
                            <span id="quiz-timer" class="text-lg font-bold text-red-400">15</span>
                        </div>
                    </div>

                    <!-- 퀴즈 내용 -->
                    <div class="quiz-content p-4 rounded-xl bg-[#2e2e4d] mb-6 min-h-[120px] flex items-center justify-center text-center">
                        <!-- **수정된 부분: break-words 클래스 추가** -->
                        <p id="quiz-question" class="text-2xl font-bold text-yellow-300 break-words">
                            ${currentQuiz.question}
                        </p>
                    </div>
                    
                    <!-- 옵션 버튼 -->
                    <div id="quiz-options" class="grid grid-cols-1 gap-4">
                        ${currentQuiz.options.map((option, index) => `
                            <button 
                                class="option-button w-full py-3 rounded-xl text-md shadow-md text-left px-4"
                                onclick="handleAnswer(this, ${index})">
                                ${index + 1}. ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        /** * @description 정답을 확인하고 UI를 업데이트합니다. 
         * @param {HTMLElement|null} selectedButton - 사용자가 클릭한 버튼
         * @param {number} selectedIndex - 사용자가 선택한 인덱스 (시간 초과 시 null)
         */
        window.handleAnswer = (selectedButton, selectedIndex) => {
            if (timerInterval) clearInterval(timerInterval); // 타이머 중지
            
            const optionsDiv = document.getElementById('quiz-options');
            const buttons = optionsDiv.querySelectorAll('button');
            const currentQuiz = currentQuizSet[currentQuizIndex];
            const isCorrect = selectedIndex === currentQuiz.answerIndex;
            
            // 모든 버튼 비활성화
            buttons.forEach(btn => btn.disabled = true);
            
            // UI 업데이트 및 기록 저장
            buttons.forEach((btn, index) => {
                const isSelected = index === selectedIndex;
                const isAnswer = index === currentQuiz.answerIndex;

                if (isAnswer) {
                    btn.classList.add('correct');
                    btn.innerHTML += ' &check; 정답';
                } else if (isSelected && !isAnswer) {
                    btn.classList.add('incorrect');
                    btn.innerHTML += ' &times; 오답';
                } else {
                    btn.classList.add('faded-out');
                }
            });
            
            // 결과 저장
            saveQuizResult(currentQuiz.id, isCorrect, currentQuiz.difficulty);
            
            // 다음 문제 버튼 추가
            const nextButton = document.createElement('button');
            nextButton.className = 'gradient-button w-full py-3 rounded-xl text-lg shadow-lg mt-6';
            nextButton.innerText = '다음 문제로';
            nextButton.onclick = () => {
                currentQuizIndex++;
                renderQuizQuestion();
            };
            optionsDiv.parentNode.appendChild(nextButton);
        }

        /** @description 퀴즈를 종료하고 결과를 표시합니다. */
        function endQuiz() {
            if (timerInterval) clearInterval(timerInterval);
            
            const total = currentQuizSet.length;
            // 퀴즈 세트의 ID를 기준으로 정답/오답을 계산합니다.
            const quizSetIds = currentQuizSet.map(q => q.id);
            const recentHistory = quizHistory.filter(h => quizSetIds.includes(h.quizId));
            const correctAnswers = recentHistory.filter(h => h.isCorrect && quizSetIds.includes(h.quizId)).length;
            const score = correctAnswers / total;

            contentDiv.innerHTML = `
                <div class="quiz-card w-full text-center p-8 shadow-2xl">
                    <p class="text-4xl font-extrabold mb-4 ${score >= 0.7 ? 'text-green-400' : 'text-red-400'}">
                        퀴즈 완료!
                    </p>
                    <p class="text-2xl font-bold mb-2">
                        ${correctAnswers} / ${total} 정답
                    </p>
                    <p class="text-xl mb-8 text-gray-300">
                        정답률: ${(score * 100).toFixed(1)}%
                    </p>
                    
                    <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" onclick="renderMainMenu()">
                        메인 메뉴로 돌아가기
                    </button>
                </div>
            `;
        }

        // =========================================================================
        // 5. 복습 모드
        // =========================================================================

        let reviewSet = []; // 복습 문제 목록 (Quiz 객체로 구성)

        /** @description 복습 모드를 시작합니다. */
        window.startReviewMode = () => {
            if (timerInterval) clearInterval(timerInterval);
            
            // 틀린 문제의 quizId 목록을 가져옵니다.
            const incorrectQuizIds = [...new Set(quizHistory
                .filter(h => !h.isCorrect)
                .map(h => h.quizId)
            )];

            // 전체 퀴즈 목록에서 해당 ID의 문제만 필터링합니다.
            const allQuizzes = [...mockQuizzes];
            reviewSet = allQuizzes.filter(quiz => incorrectQuizIds.includes(quiz.id));

            if (reviewSet.length === 0) {
                // 이미 복습이 완료되어 틀린 문제가 없는 경우
                endReview(); 
                return;
            }
            
            // 복습 모드는 섞지 않고, 오답 기록이 오래된 순서대로 정렬하거나 그냥 현재 배열을 사용합니다.
            // 여기서는 간단하게 배열 순서대로 진행합니다.
            currentQuizIndex = 0;
            renderReviewQuestion();
        };

        /** @description 현재 복습 문제를 렌더링합니다. */
        function renderReviewQuestion() {
            if (currentQuizIndex >= reviewSet.length) {
                endReview();
                return;
            }

            const currentQuiz = reviewSet[currentQuizIndex];
            const totalReview = reviewSet.length;

            contentDiv.innerHTML = `
                <div class="quiz-card w-full p-6 shadow-2xl">
                    <!-- 헤더 -->
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-[#3e3e5d]">
                        <h2 class="text-xl font-semibold text-red-400">
                            오답 복습 모드
                        </h2>
                        <span class="text-lg font-bold text-gray-300">${currentQuizIndex + 1} / ${totalReview}</span>
                    </div>

                    <!-- 퀴즈 내용 -->
                    <div class="quiz-content p-4 rounded-xl bg-[#2e2e4d] mb-6 min-h-[120px] flex items-center justify-center text-center">
                        <!-- **수정된 부분: break-words 클래스 추가** -->
                        <p id="quiz-question" class="text-2xl font-bold text-yellow-300 mb-4 break-words">
                            ${currentQuiz.question}
                        </p>
                    </div>
                    
                    <!-- 정답 표시 -->
                    <div class="bg-[#3e3e5d] p-4 rounded-xl mb-6">
                        <p class="text-lg font-bold text-green-400 mb-2">정답: ${currentQuiz.options[currentQuiz.answerIndex]}</p>
                        <p class="text-sm text-gray-400">이 문제는 이전에 틀렸던 문제입니다.</p>
                    </div>

                    <!-- 버튼 -->
                    <div class="grid grid-cols-2 gap-4">
                        <button class="option-button w-full py-3 rounded-xl text-lg shadow-md"
                            onclick="window.removeReviewItem('${currentQuiz.id}')">
                            완벽히 이해했어요! (제거)
                        </button>
                        <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-md"
                            onclick="window.nextReviewQuestion()">
                            다음 문제로
                        </button>
                    </div>
                </div>
            `;
        }

        /** @description 다음 복습 문제로 넘어갑니다. */
        window.nextReviewQuestion = () => {
            // **수정: 변수명 오타 수정**
            currentQuizIndex++;
            renderReviewQuestion();
        };
        
        /** @description 복습 목록에서 해당 문제를 제거하고 히스토리를 업데이트합니다. */
        window.removeReviewItem = (quizId) => {
            // 1. 로컬 히스토리에서 해당 문제의 오답 기록만 제거
            quizHistory = quizHistory.filter(h => !(h.quizId === quizId && !h.isCorrect));

            if (db && userId && !userId.startsWith('error-') && !userId.startsWith('anon-') && !userId.startsWith('anonymous-')) {
                // Firestore 환경에서는 onSnapshot이 변경을 감지하고 자동으로 UI를 업데이트하지만,
                // 실제 Firestore 삭제 기능은 구현하지 않았으므로 여기서는 로컬 상태만 변경합니다.
            } else {
                 // LocalStorage의 경우, 수동으로 제거 후 저장 **(핵심 수정)**
                saveQuizHistory(quizHistory);
            }
            
            // 2. 현재 복습 셋에서 해당 문제 제거
            reviewSet = reviewSet.filter(q => q.id !== quizId);
            
            // 3. 현재 인덱스에서 다음 문제 렌더링
            // 제거된 항목 때문에 인덱스를 조정할 필요 없이, 다음 항목을 현재 인덱스로 렌더링
            renderReviewQuestion();
        };

        /** @description 복습 모드를 종료합니다. */
        function endReview() {
            // 타이머 정리
            if (timerInterval) clearInterval(timerInterval);

            contentDiv.innerHTML = `
                <div class="quiz-card w-full text-center p-8 shadow-2xl">
                    <p class="text-4xl font-extrabold mb-4 text-green-400">복습 완료!</p>
                    <p class="text-xl mb-8">
                        틀렸던 모든 문제를 확인하셨습니다.
                    </p>
                    
                    <button class="gradient-button w-full py-3 rounded-xl text-lg shadow-lg" onclick="renderMainMenu()">
                        메인 메뉴로 돌아가기
                    </button>
                </div>
            `;
        }
        
        // =========================================================================
        // 6. 초기 로드
        // =========================================================================

        initializeFirebase();
        
    </script>
</body>
</html>